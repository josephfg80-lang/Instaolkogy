<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Insta Lkogy - Digital spiritual note</title>
<style>
  html, body {
    margin: 0; padding: 0; height: 100%;
    overflow: hidden; background: #000;
    font-family: Arial, sans-serif;
  }
  #appFrame {
    position: fixed; inset: 0;
    width: 100vw; height: 100vh;
    border: none; display: block;
    background: white;
  }
  #no-offline-msg {
    position: fixed; inset: 0;
    display: flex; align-items: center; justify-content: center;
    background: linear-gradient(180deg, rgba(0,0,0,0.6), rgba(0,0,0,0.85));
    color: #fff; font-size: 18px; padding: 20px;
    text-align: center; box-sizing: border-box;
    z-index: 100000;
  }
</style>
</head>
<body>

<iframe id="appFrame" allowfullscreen sandbox="allow-scripts allow-forms allow-same-origin"></iframe>
<div id="no-offline-msg" style="display:none;">âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø³Ø®Ø© Ù…Ø®Ø²Ù†Ø© Offline. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js";
import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-firestore.js";

// ===== Firebase Config =====
const firebaseConfig = {
  apiKey: "AIzaSyD9B6GcLx_ghzfB6onbGuKWAjtO74Nbyso",
  authDomain: "insta-lkogy-fb20c.firebaseapp.com",
  projectId: "insta-lkogy-fb20c",
  storageBucket: "insta-lkogy-fb20c.firebasestorage.app",
  messagingSenderId: "244190720785",
  appId: "1:244190720785:web:5881602de4b027a26452b0",
  measurementId: "G-SQ0VX5M51D"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Ø¹Ù†Ø§ØµØ± Ø§Ù„ØµÙØ­Ø©
const iframe = document.getElementById("appFrame");
const noOfflineMsg = document.getElementById("no-offline-msg");

// Ù…ÙØ§ØªÙŠØ­ Ø§Ù„ØªØ®Ø²ÙŠÙ†
const storageKey = "offlineHTML";
const storageUrlKey = "offlineURL";

// Ù…Ø±Ø¬Ø¹ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©
const settingsRef = doc(db, "config", "appSettings");

// Ø¬Ù„Ø¨ Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù…Ù† Firestore
async function getUpdateURL() {
  try {
    const snap = await getDoc(settingsRef);
    if (snap.exists() && snap.data().update) {
      return snap.data().update;
    } else {
      console.warn("âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ù‚Ù„ update ÙÙŠ ÙØ§ÙŠØ±Ø³ØªÙˆØ±.");
      return null;
    }
  } catch (err) {
    console.error("Firestore Error:", err);
    return null;
  }
}

// ØªØ­Ù…ÙŠÙ„ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø³Ø®Ø© Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª
async function updateSite(url) {
  try {
    const response = await fetch(url, { cache: "no-store" });
    if (!response.ok) throw new Error("HTTP error " + response.status);

    const html = await response.text();

    // Ø§Ù…Ø³Ø­ Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙˆØ­ÙØ¸ Ø§Ù„Ø¬Ø¯ÙŠØ¯
    localStorage.removeItem(storageKey);
    localStorage.removeItem(storageUrlKey);

    localStorage.setItem(storageKey, html);
    localStorage.setItem(storageUrlKey, url);

    iframe.srcdoc = html;
    noOfflineMsg.style.display = "none";
    console.log("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø³Ø®Ø© Ù…Ù†:", url);
  } catch (err) {
    console.warn("âš ï¸ ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·:", err);
    loadOffline();
  }
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§
function loadOffline() {
  const savedHTML = localStorage.getItem(storageKey);
  if (savedHTML) {
    iframe.srcdoc = savedHTML;
    noOfflineMsg.style.display = "none";
    console.log("ğŸ“‚ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø®Ø²Ù†Ø©.");
  } else {
    iframe.srcdoc = "";
    noOfflineMsg.style.display = "flex";
    console.log("âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø³Ø®Ø© Ù…Ø®Ø²Ù†Ø©.");
  }
}

// ===== Ø§Ù„ØªØ­Ù‚Ù‚ =====
async function checkForUpdates() {
  const url = await getUpdateURL();
  const oldURL = localStorage.getItem(storageUrlKey);

  if (url) {
    if (url !== oldURL) {
      console.log("ğŸ”„ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§ØªØºÙŠØ± â†’ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©.");
      await updateSite(url);
    } else {
      console.log("â„¹ï¸ Ø§Ù„Ø±Ø§Ø¨Ø· Ù†ÙØ³ Ø§Ù„Ù‚Ø¯ÙŠÙ… â†’ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø®Ø²Ù†Ø©.");
      loadOffline();
    }
  } else {
    console.warn("âš ï¸ Ù…ÙÙŠØ´ Ø±Ø§Ø¨Ø· ÙÙŠ ÙØ§ÙŠØ±Ø³ØªÙˆØ± â†’ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø®Ø²Ù†Ø©.");
    loadOffline();
  }
}

// ===== Init =====
window.addEventListener("DOMContentLoaded", async () => {
  await checkForUpdates();
});

// ===== Ø§Ù„ØªØ­Ù‚Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª =====
window.addEventListener("online", async () => {
  console.log("ğŸŒ Ø±Ø¬Ø¹ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª â†’ ÙØ­Øµ Ø§Ù„ØªØ­Ø¯ÙŠØ«...");
  await checkForUpdates();
});
</script>
</body>
</html>
