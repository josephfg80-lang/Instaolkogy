<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Insta Lkogy - Digital spiritual note</title>
<style>
  html, body {
    margin: 0; padding: 0; height: 100%;
    overflow: hidden; background: #000;
    font-family: Arial, sans-serif;
  }
  #appFrame {
    position: fixed; inset: 0;
    width: 100vw; height: 100vh;
    border: none; display: block;
    background: white;
  }
  #no-offline-msg {
    position: fixed; inset: 0;
    display: flex; align-items: center; justify-content: center;
    background: linear-gradient(180deg, rgba(0,0,0,0.6), rgba(0,0,0,0.85));
    color: #fff; font-size: 18px; padding: 20px;
    text-align: center; box-sizing: border-box;
    z-index: 100000;
  }
</style>
</head>
<body>

<iframe id="appFrame" allowfullscreen sandbox="allow-scripts allow-forms allow-same-origin"></iframe>
<div id="no-offline-msg" style="display:none;">❌ لا توجد نسخة مخزنة Offline. تأكد من الاتصال بالإنترنت.</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js";
import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-firestore.js";

// ===== Firebase Config =====
const firebaseConfig = {
  apiKey: "AIzaSyD9B6GcLx_ghzfB6onbGuKWAjtO74Nbyso",
  authDomain: "insta-lkogy-fb20c.firebaseapp.com",
  projectId: "insta-lkogy-fb20c",
  storageBucket: "insta-lkogy-fb20c.firebasestorage.app",
  messagingSenderId: "244190720785",
  appId: "1:244190720785:web:5881602de4b027a26452b0",
  measurementId: "G-SQ0VX5M51D"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// عناصر الصفحة
const iframe = document.getElementById("appFrame");
const noOfflineMsg = document.getElementById("no-offline-msg");

// مفاتيح التخزين
const storageKey = "offlineHTML";
const storageUrlKey = "offlineURL";

// مرجع الوثيقة
const settingsRef = doc(db, "config", "appSettings");

// جلب رابط التحديث من Firestore
async function getUpdateURL() {
  try {
    const snap = await getDoc(settingsRef);
    if (snap.exists() && snap.data().update) {
      return snap.data().update;
    } else {
      console.warn("⚠️ لا يوجد حقل update في فايرستور.");
      return null;
    }
  } catch (err) {
    console.error("Firestore Error:", err);
    return null;
  }
}

// تحميل وتحديث النسخة من الإنترنت
async function updateSite(url) {
  try {
    const response = await fetch(url, { cache: "no-store" });
    if (!response.ok) throw new Error("HTTP error " + response.status);

    const html = await response.text();

    // امسح القديم وحفظ الجديد
    localStorage.removeItem(storageKey);
    localStorage.removeItem(storageUrlKey);

    localStorage.setItem(storageKey, html);
    localStorage.setItem(storageUrlKey, url);

    iframe.srcdoc = html;
    noOfflineMsg.style.display = "none";
    console.log("✅ تم تحديث النسخة من:", url);
  } catch (err) {
    console.warn("⚠️ فشل التحميل من الرابط:", err);
    loadOffline();
  }
}

// تحميل النسخة المخزنة محليًا
function loadOffline() {
  const savedHTML = localStorage.getItem(storageKey);
  if (savedHTML) {
    iframe.srcdoc = savedHTML;
    noOfflineMsg.style.display = "none";
    console.log("📂 تشغيل النسخة المخزنة.");
  } else {
    iframe.srcdoc = "";
    noOfflineMsg.style.display = "flex";
    console.log("❌ لا توجد نسخة مخزنة.");
  }
}

// ===== التحقق =====
async function checkForUpdates() {
  const url = await getUpdateURL();
  const oldURL = localStorage.getItem(storageUrlKey);

  if (url) {
    if (url !== oldURL) {
      console.log("🔄 الرابط اتغير → تحميل النسخة الجديدة.");
      await updateSite(url);
    } else {
      console.log("ℹ️ الرابط نفس القديم → استخدام النسخة المخزنة.");
      loadOffline();
    }
  } else {
    console.warn("⚠️ مفيش رابط في فايرستور → استخدام النسخة المخزنة.");
    loadOffline();
  }
}

// ===== Init =====
window.addEventListener("DOMContentLoaded", async () => {
  await checkForUpdates();
});

// ===== التحقق عند الاتصال بالإنترنت =====
window.addEventListener("online", async () => {
  console.log("🌐 رجع الإنترنت → فحص التحديث...");
  await checkForUpdates();
});
</script>
</body>
</html>
