<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="INSTA LKOGY - ŸÜÿ∏ÿßŸÖ ÿ™ÿ™ÿ®ÿπ ÿßŸÑŸÜŸÇÿßÿ∑">
    <link rel="icon" href="WEb icon-modified.png"/>
    <link rel="shortcut" href="WEb icon-modified.png"/>
    <link rel="apple-touch-icon" href="WEb icon-modified.png"/>
    <meta name="theme-color" content="#FF6B35">
    <title>INSTA LKOGY</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
    <script src="html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>

/* Scrollbar for Webkit-based browsers (Chrome, Edge, Safari) */
::-webkit-scrollbar {
    width: 10px; /* Width of the scrollbar */
}

::-webkit-scrollbar-track {
    background: rgb(119, 27, 27); /* Dark background for the track */
    border-radius: 10px;
}

::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #ff416c, #ff4b2b); /* Gradient for a stylish effect */
    border-radius: 10px;
    transition: 0.3s ease-in-out;
}

::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, #ff4b2b, #ff416c); /* Subtle color change on hover */
}

#loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: black; /* Dark mode */
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 9999;
            transition: opacity 1s ease-in-out;
        }

        /* Neon Glow Text */
        .loading-text {
            font-size: 24px;
            font-weight: bold;
            color: #03fa6e;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 0 10px #03fa6e, 0 0 20px #03fa6e, 0 0 40px #03fa6e;
            animation: glow 1.5s infinite alternate;
        }

        @keyframes glow {
            0% { text-shadow: 0 0 10px #03fa6e; }
            100% { text-shadow: 0 0 20px #03fa6e, 0 0 40px #03fa6e; }
        }

        /* Cube Loader */
        .cube {
            width: 50px;
            height: 50px;
            position: relative;
            transform-style: preserve-3d;
            animation: rotateCube 2s infinite linear;
        }

        .cube:not(.cube-start) {
            right: 65px;
        }

        .cube div {
            position: absolute;
            width: 100%;
            height: 100%;
            background: rgba(3, 250, 110, 0.8);
            border: 2px solid #03fa6e;
            box-shadow: 0 0 10px #03fa6e;
        }

        .cube .front  { transform: translateZ(25px); }
        .cube .back   { transform: rotateY(180deg) translateZ(25px); }
        .cube .left   { transform: rotateY(-90deg) translateZ(25px); }
        .cube .right  { transform: rotateY(90deg) translateZ(25px); }
        .cube .top    { transform: rotateX(90deg) translateZ(25px); }
        .cube .bottom { transform: rotateX(-90deg) translateZ(25px); }

        @keyframes rotateCube {
            0% { transform: rotateX(0) rotateY(0); }
            100% { transform: rotateX(360deg) rotateY(360deg); }
        }

        /* Fade-out effect */
        .hide {
            opacity: 0;
            pointer-events: none;
        }

        /* Page Content (Hidden Initially) */
        #content {
            display: none;
            text-align: center;
            padding: 50px;
            color: white;
            font-size: 24px;
        }

        /* Background Animation */
        body {
            background: radial-gradient(circle, rgba(0,0,0,1) 0%, rgba(3,250,110,0.1) 100%);
            color: white;
            text-align: center;
        }


        :root {
            --primary-color: #FF6B35;
            --secondary-color: #FF5722;
            --gradient-start: #833ab4;
            --gradient-middle: #fd1d1d;
            --gradient-end: #fcb045;
            --text-color: #333;
            --white: #ffffff;
            --error: #ff3333;
            --success: #4CAF50;
            --warning: #ff9800;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Cairo', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: linear-gradient(45deg, #833ab4, #fd1d1d, #fcb045);
            background: -webkit-linear-gradient(45deg, #833ab4, #fd1d1d, #fcb045);
            min-height: 100vh;
            color: #333;
            padding: 20px;
            line-height: 1.6;
        }

        button{
            cursor: pointer;
        }


        .container {
            max-width: 600px;
            margin: 0 auto;
            overflow: hidden;  /* Prevent content from spilling out */
            hyphens: auto;          /* Automatically adds hyphens where appropriate */
        }



        .header {
            text-align: left;
            margin-bottom: 30px;
            color: var(--white);
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            animation: fadeIn 1s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .developer-credit {
            background-color: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 5px;
            font-size: 0.9em;
            backdrop-filter: blur(5px);
        }

        .card {
            background: var(--white);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            background-color: rgba(255, 255, 255, 0.95);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .points-container {
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }

        .points-label {
            color: #333;
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .points-value {
            color: var(--secondary-color);
            font-size: 2.5em;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        /* .points-value::after{
            content: "";
            display: inline-block;
            width: 50px;
            height: 50px;
            background: url("lkogy-logo-removebg-preview.png") no-repeat center / contain;
            position: absolute;
            transform: translate(18px,-13px) rotate(-60deg) scale(1.2);
        } */

        .logo-image {
            width: 80px;
            height: 80px;
            object-fit: contain;
            animation: floatAnimation 3s ease-in-out infinite;
        }

        @keyframes floatAnimation {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @media (max-width: 600px) {
            .points-container {
                flex-direction: column;
            }
            .logo-image {
                width: 60px;
                height: 60px;
            }
        }
        .button {
            background-color: var(--secondary-color);
            color: var(--white);
            border: none;
            border-radius: 10px;
            padding: 15px;
            width: 100%;
            font-size: 1.1em;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            overflow: hidden;
        }

        .button::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, .5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }

        .button:focus:not(:active)::after {
            animation: ripple 1s ease-out;
        }
        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 0.5;
            }
            100% {
                transform: scale(100, 100);
                opacity: 0;
            }
        }

        .button:disabled {
            background-color: rgba(204, 204, 204, 0.8);
            cursor: not-allowed;
        }

        .button:disabled::after {
            content: '‚úì';
            margin-left: 10px;
            font-size: 1.2em;
        }

        .button:hover:not(:disabled) {
            background-color: #FF6B35;
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .activity-button {
            background: linear-gradient(135deg, #FF416C, #FF4B2B);
            background: -webkit-linear-gradient(135deg, #FF416C, #FF4B2B);
        }

        .spend-button {
            background: linear-gradient(135deg, #11998e, #38ef7d);
            background: -webkit-linear-gradient(135deg, #11998e, #38ef7d);
            margin: 20px 0;
            padding: 20px;
            font-size: .9em;
            border-radius: 15px;
        }

        .exchange-button {
            background: linear-gradient(135deg, #FF6A00, #EE0979);
            background: -webkit-linear-gradient(135deg, #FF6A00, #EE0979);
            font-size: 0.9em;
            padding: 10px;
            position: relative;
        }
        .exchange-button::before{
            content: attr(data-length);
            display: inline-block;
            width: 20px;
            height: 20px;
            background: linear-gradient(-135deg, #FF6A00, #EE0979);
            border-radius: 50%;
            position: absolute;
            top: 2px;
            right: 5px;
            transform: scale(1.3);
            z-index: 999;
        }

        .exchange-button.hide-before::before {
          display: none;
        }

        .deposit-button {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            background: -webkit-linear-gradient(135deg, #4CAF50, #45a049);
            font-size: 0.9em;
            padding: 10px;
        }
        .scan-button {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            background: -webkit-linear-gradient(135deg, #2196F3, #1976D2);
            font-size: 0.9em;
            padding: 10px;
        }

        .badge {
            background-color: rgba(255, 255, 255, 0.2);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.9em;
            backdrop-filter: blur(5px);
        }

        .history-container {
            max-height: 300px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--secondary-color) transparent;
        }

        .history-container::-webkit-scrollbar {
            width: 6px;
        }

        .history-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .history-container::-webkit-scrollbar-thumb {
            background-color: var(--secondary-color);
            border-radius: 3px;
        }

        .history-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.3s ease;
        }

        .history-item:hover {
            background-color: rgba(0, 0, 0, 0.02);
        }

        .history-item.earn {
            color: var(--success);
        }

        .history-item.spend {
            color: var(--error);
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-content {
            background: var(--white);
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .prodModalCont {
            display: flex;
            align-items: center;
            flex-direction: column;
            gap: 20px;
        }

        .modal-title {
            font-size: 1.2em;
            margin-bottom: 15px;
            color: #333;
        }

        .modal-subtitle {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 20px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .confirm-button {
            background-color: var(--success);
            color: var(--white);
        }

        .cancel-button {
            background-color: var(--error);
            color: var(--white);
        }

        input[type="number"], input[type="password"] ,#nameLoginInput{
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 1.1em;
            transition: border-color 0.3s ease;
        }

        input[type="number"]:focus, input[type="password"]:focus ,#nameLoginInput:focus{
            outline: none;
            border-color: var(--secondary-color);
        }

        .cooldown {
            font-size: 0.8em;
            color: var(--error);
            margin-left: 5px;
        }

        .settings-button {
            background-color: rgba(102, 102, 102, 0.8);
            font-size: 0.9em;
            padding: 10px;
            margin-top: 10px;
        }

        .password-group {
            margin-bottom: 15px;
        }
        .password-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 5px 0;
            font-size: 1.1em;
        }

        .error-message {
            color: var(--error);
            font-size: 0.9em;
            margin-top: 5px;
            display: none;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
        }

        .action-buttons .button {
            margin: 0;
            flex: 0.7 1 100px;
            padding: 20px;
            text-align: center;
            font-size: 0.7em;
            display: flex;
            justify-content: center;
        }

    .product {
        background: linear-gradient(135deg, var(--gradient-start), var(--gradient-middle), var(--gradient-end));
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        min-width: 80%;
        max-width: 97%;
        /* height: 400px; */
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: white;
        text-align: center;
    }

    .product img {
        border-radius: 10px;
        margin-bottom: 15px;
    }

    .product p {
        font-size: 1.2em;
        margin-bottom: 20px;
    }
    
    /* Product Name - stands out on gradients */
    .ProdName {
      color: #FFFFFF; /* Pure white */
      font-weight: bold;
      font-size: 1.3em;
      text-shadow: 0 1px 3px rgba(0,0,0,0.3); /* Improves readability */
    }
    
    /* Product Description - subtle but readable */
    .ProdDescription {
      color: rgba(255,255,255,0.9); /* Slightly transparent white */
      font-size: 1em;
      margin-top: 5px;
    }
    
    /* Price - stands out with bright color */
    .ProdPrice {
      color: #FFD700; /* Gold color */
      font-weight: bold;
      font-size: 1.2em;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
      margin-top: 10px;
    }
    
    /* Order Button */
    .OrderButton {
      background: linear-gradient(135deg, #FF6B35, #FF416C);
      color: white;
      border: none;
      padding: 8px 20px;
      border-radius: 20px;
      font-weight: bold;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    /* Ordered State */
    .OrderButton:disabled {
      background: #555; /* Dark gray */
      color: #AAA;
    }

    .product button {
        /* background-color: black;
        color: var(--white); */
        border: none;
        border-radius: 10px;
        padding: 10px 20px;
        font-size: 1em;
        cursor: pointer;
        animation: vibration 0.2s linear infinite;
        transition: background-color 0.3s ease;
        transition: all 0.3s ease;
    }

    .product button:hover {
        scale: 1.05;
    }

    .product button[disabled] {
        /* background-color: rgba(160, 160, 160, 0.8); */
        cursor: not-allowed;
    }
    .product button[disabled]:hover {
        scale: 1;
    }


        .permission-error {
            color: white;
            text-align: center;
            margin: 20px auto;
            padding: 20px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 15px;
            max-width: 400px;
            display: none;
        }

        .permission-error h3 {
            color: white;
            margin-bottom: 15px;
        }

        .permission-error ol {
            list-style-position: inside;
        }

        .permission-error li {
            margin: 10px 0;
            text-align: right;
        }

        .camera-retry-button {
            background: #FF6B35;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            margin-top: 15px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }

        .camera-retry-button:hover {
            background: var(--secondary-color);
        }

        .close-button {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 24px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.3s ease;
            z-index: 999;
        }

        .close-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }



        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }

            .button {
                padding: 12px;
            }

            .points-value {
                font-size: 2em;
            }

            .modal-content {
                width: 95%;
                margin: 10px;
                max-height: 85vh;
            }
            #settingsContent {
                max-height: calc(85vh - 100px);
            }
            .scanner-container {
                padding: 10px;
            }
            .action-buttons .button{
                font-size: .5em;
            }
        }
        @media (max-width: 520px) { 
            .password-status{
                width: 20px !important;
            }
        }
        @media (max-width: 475px) {
            .header {
                text-align: center;
                align-items: center;
            }
            .button , .developer-credit{
                font-size: .8em;
            }
        }
        @media (max-width: 370px) {
            .password-status{
                width: clamp(25px , 2vw , 30px) !important;
            }
        }
        @media (max-width: 480px) {
            .action-buttons .button{
                font-size: .58em;
            }
        }
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            z-index: 1001;
            display: none;
            animation: toastFadeIn 0.3s ease;
        }

        @keyframes toastFadeIn {
            from { opacity: 0; transform: translate(-50%, 20px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }
        .password-status {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
            background-color: #4CAF50;
            transition: background-color 0.3s ease;
        }

        .password-status.changed {
            background-color: #ff3333;
        }

        #qrcode {
            text-align: center;
            margin: 20px 0;
        }

        #reader {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            overflow: hidden;
        }

        .scanner-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .scanner-container .close-button {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s ease;
        }

        .scanner-container .close-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Add new styles for task management */
        .settings-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        .settings-section h4 {
            margin-bottom: 15px;
            color: #333;
        }

        .tasks-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .task-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        .task-item:last-child {
            border-bottom: none;
        }

        .task-details {
            flex: 1;
            margin-right: 10px;
        }

        .task-points {
            width: 80px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
        }

        .task-icon {
            margin-right: 10px;
            font-size: 1.2em;
        }

        .delete-task {
            color: var(--error);
            cursor: pointer;
            padding: 5px;
            margin-left: 10px;
        }

        .core-task {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .core-task-badge {
            font-size: 0.8em;
            padding: 2px 6px;
            background-color: var(--secondary-color);
            color: white;
            border-radius: 4px;
            margin-left: 5px;
        }

        .add-task-form {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
        }

        .add-task-form input {
            margin-bottom: 10px;
        }

        #settingsContent {
            max-height: calc(90vh - 120px);
            overflow-y: auto;
            padding-right: 10px;
        }

        /* Add camera permission styles */
        .camera-permission {
            color: white;
            text-align: center;
            margin: 20px 0;
            padding: 10px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
        }

        /* Add camera preview styles */
        #cameraPreview {
            width: 100%;
            max-width: 600px;
            height: 300px;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
        }
        .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: scale(0);
            animation: ripple-animation 0.6s linear;
            pointer-events: none;
        }

        @keyframes ripple-animation {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        .button {
            overflow: hidden;
            position: relative;
            transform: translate3d(0, 0, 0);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                        background 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                        box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .button:active {
            transform: scale(0.98);
        }

        .modal {
            animation: modalSlide 0.3s ease-out;
        }

        @keyframes modalSlide {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /*completed task styles*/
        .completed-task-icon {
            color: var(--success);
            margin-left: 5px;
            font-size: 1.2em;
        }

        .activity-button.completed {
            background: linear-gradient(135deg, #666, #999);
            background: -webkit-linear-gradient(135deg, #666, #999);
            position: relative;
        }

        .activity-button.completed::after {
            content: '‚úì';
            position: absolute;
            right: 10px;
            color: var(--success);
            font-size: 1.2em;
        }

        /* Login */
        #loginContainer{
            display: flex;
            justify-content: center;
            align-items: center;
            position: fixed;
            top: 0px;
            bottom: 0px;
            right: 0px;
            left: 0px;
            width: 100%;
            height: 100%;
            z-index: 99;
            background: linear-gradient(45deg, #833ab493, #fd1d1d93, #fcb04593);
            background: -webkit-linear-gradient(45deg, #833ab493, #fd1d1d93, #fcb04593);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        #loginModal{
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.555);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            flex-direction: column;
            border-radius: 10px;
            padding: 40px;
        }
        #nameLoginInput, #passwordLoginInput{
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            border: 2px solid #ddd;
            font-size: 16px;
            transition: all 0.3s ease;
            background-color: rgba(255, 255, 255, 0.9);
        }

        #nameLoginInput:focus, #passwordLoginInput:focus {
            outline: none;
            border-color: var(--success);
            box-shadow: 0 0 8px rgba(76, 175, 80, 0.3);
            background-color: white;
        }

        #nameLoginInput::placeholder, #passwordLoginInput::placeholder {
            color: #999;
            font-style: italic;
        }
        #loginModal  label{
            font-size: 1.2em;
            font-weight: 900;
            margin-top: 10px;
        }
        #loginButton{
            border-radius: 10px;
            padding: 10px;
            background-color: var(--success);
            margin-top: 20px;
            color: black;
            font-weight: 900;
            border: none;
            font-size: 18px;
            width: 100%;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        #loginButton:hover {
            background-color: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        #loginButton:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        #loginTitle{
            color: black;
            font-size: 25px;
            font-weight: 900;
            margin-bottom: 20px;
            margin-right: 40px;
            margin-left: 40px;
        }

        .container{
            display: none;
        }

        #logout {
        width: 90%;
        border-radius: 10px;
        border: none;
        padding: 8px 0;
        background: linear-gradient(135deg, #ff416c, #ff4b2b);
        background: -webkit-linear-gradient(135deg, #ff416c, #ff4b2b);
        color: white;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: 0.3s ease-in-out;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
    }

    #logout:hover {
    background: linear-gradient(135deg, #ff4b2b, #ff416c);
    background: -webkit-linear-gradient(135deg, #ff4b2b, #ff416c);
    transform: scale(1.05);
    }
    table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0 0.5rem;
        margin-top: 1rem;
    }
    
    
    th, td {
        padding: 1rem;
        text-align: right;
      }

      th {
        font-weight: 900;
        color: #FF6B35;
        text-transform: uppercase;
        font-size: 0.875rem;
        letter-spacing: 0.05em;
      }

      tbody tr {
        background: var(--glass-bg);
        border-radius: 0.75rem;
        transition: all 0.2s;
      }
      tbody tr:nth-child(odd){
        background-color: rgba(0, 0, 0, 0.05);
      }
      tbody tr:not(:first-child):hover {
        transform: translateY(-2px);
        background-color: rgba(0, 0, 0, 0.05);
      }
      tbody tr:first-child:hover{
        transform: translateY(-2px);
      }
      tbody tr:first-child{
        background-color: #ff4400;
        box-shadow: #ff4400 0px 0px 20px;
     }
     tbody tr:first-child td{
        color: white;
      }
      tbody td:first-child {
        border-radius: 0 0.75rem 0.75rem 0;
      }

      tbody td , th{
        text-align: center;
      }

      tbody td:last-child {
        border-radius: 0.75rem 0 0 0.75rem;
      }
      #usersTableTitle{
        color: white;
      }
      #usersTableTitleContainer{
        display: inline-flex;
        justify-content: center;
        align-items: center;
        background-color: goldenrod;
        border-radius: 15px;
        padding-left: 15px;
        padding-right: 15px;
        padding-top: 5px;
        padding-bottom: 5px;
        transform: scale(0.9);
      }

      .purchase-loading-overlay {
           position: fixed;
           top: 0;
           left: 0;
           width: 100%;
           height: 100%;
           background-color: rgba(0, 0, 0, 0.7);
           display: flex;
           justify-content: center;
           align-items: center;
           z-index: 9999;
           display: none;
       }
       
       .purchase-loading-content {
           color: white;
           font-size: 1.5em;
           text-align: center;
       }
      @media (max-width: 520px){
        #usersTable{
            display: block;
            overflow-x: auto;
            white-space: nowrap;
        }
      }


        /* Out of stock styling */
        /* .product[data-status="out_of_stock"] {
          opacity: 0.7;
          position: relative;
        }
        .product[data-status="out_of_stock"]::after {
          content: "ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ±"; /* Keep Arabic text */
          /*position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          /*background-color: #000000; /* Black */
          /*color: white;
          padding: 5px 10px;
          /*border-radius: 5px;
          font-weight: bold;
        } */

        /* Date Styling */

        #Today-Cont{
            margin-top: 20px;
        }

        /*Jesus Has Risen*/

        #app-title{
            margin-top: 10px;
        }

        .product {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-middle), var(--gradient-end));
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            min-width: 80%;
            max-width: 97%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
        }

        .product img {
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .product p {
            font-size: 1.2em;
            margin-bottom: 20px;
        }
        
        /* Product Name - stands out on gradients */
        .ProdName {
          color: #FFFFFF;
          font-weight: bold;
          font-size: 1.3em;
          text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        
        /* Product Description - subtle but readable */
        .ProdDescription {
          color: rgba(255,255,255,0.9);
          font-size: 1em;
          margin-top: 5px;
        }
        
        /* Price - stands out with bright color */
        .ProdPrice {
          color: #FFD700;
          font-weight: bold;
          font-size: 1.2em;
          text-shadow: 0 1px 2px rgba(0,0,0,0.3);
          margin-top: 10px;
        }
        
        /* Price Options */
        .price-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
            margin: 10px 0;
        }
        
        .price-option-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 20px;
            padding: 10px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .price-option-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .price-option-btn.selected {
            background: var(--success);
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }
        
        /* Order Button */
        /* .OrderButton {
          background: linear-gradient(135deg, #FF6B35, #FF416C);
          color: white;
          border: none;
          padding: 8px 20px;
          border-radius: 20px;
          font-weight: bold;
          box-shadow: 0 2px 5px rgba(0,0,0,0.2);
          margin-top: 10px;
        }
        
        /* Ordered State */
        /*.OrderButton:disabled {
          background: #555;
          color: #AAA;
        } */

        /* Out of stock styling */
        /* .product[data-status="out_of_stock"] {
          opacity: 0.7;
          position: relative;
        }
        .product[data-status="out_of_stock"]::after {
          content: "ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ±";
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background-color: #000000;
          color: white;
          padding: 5px 10px;
          border-radius: 5px;
          font-weight: bold;
        } */

        .quest-action-btn {
          background: linear-gradient(135deg, #FF512F, #F09819);
          color: white;
          border: none;
          border-radius: 12px;
          padding: 12px 20px;
          margin: 5px;
          font-size: 1.1em;
          font-weight: bold;
          box-shadow: 0 2px 8px rgba(255,81,47,0.15);
          transition: background 0.2s, transform 0.2s;
          cursor: pointer;
          display: inline-flex;
          align-items: center;
          gap: 8px;
        }
        .quest-action-btn:hover {
          background: linear-gradient(135deg, #F09819, #FF512F);
          transform: scale(1.04);
        }

        /* Add to your existing styles */
#offlineContainer, #recoveryContainer {
    animation: fadeIn 0.5s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

#retryConnection, #retryConnectionRecovery {
    transition: all 0.3s ease;
}

#retryConnection:hover, #retryConnectionRecovery:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
}

#retryConnection:active, #retryConnectionRecovery:active {
    transform: translateY(0);
}
    </style>
</head>
<body>


        <div  id="loading-screen">
        <div style=" position: absolute; top: 20px; text-align: center; background: #000; padding: 30px; border-radius: 10px; box-shadow: 0 0 15px rgba(3, 250, 110, 0.3);">
        <span style="color: #fff; font-size: 30px;">Developed with ‚ù§Ô∏è by <b style="color: #03fa6e;">Joseph Fady , Marc Akram , Samuel Mina and Jovany Fady</b></span>
        </div>
        
        <p class="loading-text">ÿ™ÿ≠ŸÖŸäŸÑ...</p>
        <div style="margin-top: 20px;" class="cube cube-start">
            <div class="front"></div>
            <div class="back"></div>
            <div class="left"></div>
            <div class="right"></div>
            <div class="top"></div>
            <div class="bottom"></div>
        </div>
    </div>

    <!-- Page Content -->



    <div id="loginContainer">
        <div id="loginModal">
            <span id="loginTitle">ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ</span>
            <label for="nameLoginInput">ÿßÿØÿÆŸÑ ÿßÿ≥ŸÖŸÉ</label>
            <input type="text" id="nameLoginInput" placeholder="ÿßŸÑÿßÿ≥ŸÖ">
            <label for="passwordLoginInput">ÿßÿØÿÆŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±</label>
            <input type="password" id="passwordLoginInput" placeholder="ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±">
            <button id="loginButton">ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ</button>
        </div>
    </div>


    <div style="margin-top: 50px;" class="container">
        <div class="header">
            <div id="Jesus-rise" style="display: none; background-color: blue;border-radius: 14px;padding: 10px;position: absolute;top: 35px;right: 5px;font-size: 12px;">
                ÿßŸÑŸÖÿ≥Ÿäÿ≠ ŸÇÿßŸÖ... ÿ®ÿßŸÑÿ≠ŸÇŸäŸÇÿ© ŸÇÿßŸÖ
            </div>
            <h1 id="app-title">INSTA LKOGY</h1>
            <div class="developer-credit">
                <div>
                    <span>Developed with ‚ù§Ô∏è by Joseph Fady and Jovany Fady </span>
                    <span>in collaboration with</span>
                    <a href="https://marc-and-sam.blogspot.com/" target= "blank" style="color: #03fa6e; text-decoration:  underline #03fa6e;font-weight: 900;">
                        Marc&Sam
                    </a>
                    <span>Team</span>
                                
                </div>
                <span class="password-status" id="passwordStatus"></span>
            </div>
            <div id="Today-Cont">
                <span id="Date"></span>
            </div>
        </div>

        <div class="card points-container">
            <div>
                <div class="points-label">ÿ±ÿµŸäÿØ ÿßŸÑŸÑŸÉŸàÿ¨Ÿä</div>
                <div class="points-value">0</div>
            </div>
        </div>
        <div class="action-buttons">
            <button class="button spend-button" onclick="showSpendModal()">
                ÿµÿ±ŸÅ ŸÑŸÉŸàÿ¨Ÿä
            </button>
            <button class="button exchange-button" onclick="showExchangeModal()">
                Lkogy Shop üõí
            </button>
            <button class="button deposit-button" onclick="showDepositModal()">
                ÿ•ŸäÿØÿßÿπ ŸÑŸÉŸàÿ¨Ÿä
            </button>
            <button class="button scan-button" onclick="startScanner()">
                ŸÖÿ≥ÿ≠ ÿ®ÿßÿ±ŸÉŸàÿØ
            </button>
            <button class="button" id="bonusChallengeBtn" style="background: linear-gradient(135deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888); color: #fff;" onclick="showBonusChallengeModal()">
                ÿ™ÿ≠ÿØŸäÿßÿ™ Bonus
            </button>
        </div>


        <style>

    .new-badge {
        color: white;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
        background-color: red;
}
    </style>


        <div id="activitiesList"></div>
        <div id="usersTableTitleContainer">
            <h1 id="usersTableTitle">Top 5</h1>
            <img src="TOP5-removebg-preview.png" style="width: 50px;height: 50px;" alt="Top 5">
        </div>
        <table id="usersTable" class="card">
            <thead>
              <tr>
                <th>ÿßŸÑÿ™ÿµŸÜŸäŸÅ</th>
                <th>ÿßŸÑÿßÿ≥ŸÖ</th>
                <th>ÿπÿØÿØ ÿßŸÑŸÑŸÉŸàÿ¨Ÿä</th>
              </tr>
            </thead>
            <tbody></tbody>
        </table>
        <div class="card">
            <h3>ÿ≥ÿ¨ŸÑ ÿßŸÑÿ≠ÿ±ŸÉÿßÿ™</h3>
            <div id="historyList" class="history-container"></div>
        </div>

        <button class="button settings-button" onclick="showSettingsModal()">
            ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™
        </button>
    </div>

    <div id="spendModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">ÿµÿ±ŸÅ ŸÑŸÉŸàÿ¨Ÿä</h3>
            <input type="number" id="spendAmount" placeholder="ÿ£ÿØÿÆŸÑ ÿπÿØÿØ ÿßŸÑŸÜŸÇÿßÿ∑" min="1">
            <div id="spendError" class="error-message"></div>
            <div class="modal-buttons">
                <button class="modal-button confirm-button" onclick="confirmSpend()">ÿ™ÿ£ŸÉŸäÿØ</button>
                <button class="modal-button cancel-button" onclick="closeModal('spendModal')">ÿ•ŸÑÿ∫ÿßÿ°</button>
            </div>
        </div>
    </div>

    <div id="depositModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">ÿ•ŸäÿØÿßÿπ ŸÑŸÉŸàÿ¨Ÿä</h3>
            <div class="password-group">
                <input type="password" id="teacherPassword" placeholder="ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±">
                <div id="passwordError" class="error-message"></div>
            </div>
            <input type="number" id="depositAmount" placeholder="ÿπÿØÿØ ÿßŸÑŸÜŸÇÿßÿ∑" min="1">
            <div id="depositError" class="error-message"></div>
            <div id="qrcode"></div>
            <div class="modal-buttons">
                <button class="modal-button confirm-button" onclick="confirmDeposit()">ÿ•ŸäÿØÿßÿπ ŸÖÿ®ÿßÿ¥ÿ±</button>
                <button class="modal-button confirm-button" onclick="generateQRCode()" style="display: none;">ÿ•ŸÜÿ¥ÿßÿ° ÿ®ÿßÿ±ŸÉŸàÿØ</button>
                <button class="modal-button cancel-button" onclick="closeModal('depositModal')">ÿ•ŸÑÿ∫ÿßÿ°</button>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™</h3>

            <!-- Password Verification Section -->
            <div id="settingsPasswordSection">
                <div class="password-group">
                    <input type="password" id="settingsPassword" placeholder="ÿ£ÿØÿÆŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±">
                </div>
                <div class="modal-buttons">
                    <button class="modal-button confirm-button" onclick="verifySettingsPassword()">ÿØÿÆŸàŸÑ</button>
                    <button class="modal-button cancel-button" onclick="closeModal('settingsModal')">ÿ•ŸÑÿ∫ÿßÿ°</button>
                </div>
            </div>

            <!-- Settings Content -->
            <div id="settingsContent" style="display: none;">
                <!-- Password Change Section -->
                <div class="settings-section">
                    <h4>ÿ™ÿ∫ŸäŸäÿ± ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±</h4>
                    <div class="password-group">
                        <input type="password" id="currentPassword" placeholder="ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿßŸÑÿ≠ÿßŸÑŸäÿ©">
                    </div>
                    <div class="password-group">
                        <input type="password" id="newPassword" placeholder="ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿßŸÑÿ¨ÿØŸäÿØÿ©">
                    </div>
                    <div class="modal-buttons">
                        <button class="modal-button confirm-button" onclick="changePassword()">ÿ™ÿ∫ŸäŸäÿ±</button>
                    </div>
                </div>

                <!-- Task Management Section -->
                <!-- <div class="settings-section">
                    <h4>ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸáÿßŸÖ</h4>
                    <div id="tasksList" class="tasks-list">
                         Tasks will be populated here
                    </div>

                     Add New Task Form 
                    <div class="add-task-form">
                        <h4>ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸáŸÖÿ© ÿ¨ÿØŸäÿØÿ©</h4>
                        <input type="text" id="newTaskName" placeholder="ÿßÿ≥ŸÖ ÿßŸÑŸÖŸáŸÖÿ©">
                        <input type="number" id="newTaskPoints" placeholder="ÿπÿØÿØ ÿßŸÑŸÜŸÇÿßÿ∑" min="1">
                        <input type="text" id="newTaskIcon" placeholder="ÿßŸÑÿ±ŸÖÿ≤ (emoji)" maxlength="2">
                        <select id="newTaskStatus">
                            <option value="visible">ÿ∏ÿßŸáÿ±ÿ©</option>
                            <option value="hidden">ŸÖÿÆŸÅŸäÿ©</option>
                        </select>
                        <select id="newTaskGender">
                            <option value="all">ÿßŸÑÿ¨ŸÖŸäÿπ</option>
                            <option value="Male">ÿßŸÑÿ£ŸàŸÑÿßÿØ ŸÅŸÇÿ∑</option>
                            <option value="Female">ÿßŸÑÿ®ŸÜÿßÿ™ ŸÅŸÇÿ∑</option>
                        </select>
                        <select id="newTaskStage">
                            <option value="all">ÿßŸÑÿ¨ŸÖŸäÿπ</option>
                            <option value="first">ÿßŸÑÿ£ŸàŸÑŸâ</option>
                            <option value="second">ÿßŸÑÿ´ÿßŸÜŸäÿ©</option>
                            <option value="third">ÿßŸÑÿ´ÿßŸÑÿ´ÿ©</option>
                        </select>
                        <div style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px;">
                            <label><input type="checkbox" name="newTaskDays" value="0" checked> ÿßŸÑÿ£ÿ≠ÿØ</label>
                            <label><input type="checkbox" name="newTaskDays" value="1" checked> ÿßŸÑÿ•ÿ´ŸÜŸäŸÜ</label>
                            <label><input type="checkbox" name="newTaskDays" value="2" checked> ÿßŸÑÿ´ŸÑÿßÿ´ÿßÿ°</label>
                            <label><input type="checkbox" name="newTaskDays" value="3" checked> ÿßŸÑÿ£ÿ±ÿ®ÿπÿßÿ°</label>
                            <label><input type="checkbox" name="newTaskDays" value="4" checked> ÿßŸÑÿÆŸÖŸäÿ≥</label>
                            <label><input type="checkbox" name="newTaskDays" value="5" checked> ÿßŸÑÿ¨ŸÖÿπÿ©</label>
                            <label><input type="checkbox" name="newTaskDays" value="6" checked> ÿßŸÑÿ≥ÿ®ÿ™</label>
                        </div>
                        <select id="newTaskRefreshCycle">
                            <option value="daily">ŸäŸàŸÖŸä</option>
                            <option value="15days">ŸÉŸÑ 15 ŸäŸàŸÖ</option>
                        </select>
                        <button class="modal-button confirm-button" onclick="addNewTask()">ÿ•ÿ∂ÿßŸÅÿ©</button>
                    </div>
                </div> -->
                <center>
                    <button onclick="Logout()" id="logout">
                        ÿ™ÿ≥ÿ¨ŸäŸÑ ÿÆÿ±Ÿàÿ¨
                    </button>
                </center>
                <button class="modal-button cancel-button" onclick="closeModal('settingsModal')">ÿ•ÿ∫ŸÑÿßŸÇ</button>
            </div>
        </div>
    </div>
    <div id="exchangeModal" class="modal">
        <button class="close-button" onclick="closeModal('exchangeModal')">x</button>
        <div class="modal-content prodModalCont">
            <div class="modal-title">Lkogy Shop üõí</div>
            <div id="productsContainer" style="display: flex; align-items: center; flex-direction: column; gap: 20px;">
                <!-- Products will be dynamically inserted here -->
            </div>
        </div>
    </div>


    <!-- Bonus Challenge Modal -->
    <div id="bonusChallengeModal" class="modal">
        <div class="modal-content" style="background: rgba(255,255,255,0.99); color: #222; border-radius: 1rem; max-width: 500px;">
            <h3 style="color:#cc2366; margin-bottom:1rem;">ÿ™ÿ≠ÿØŸäÿßÿ™ Bonus</h3>
            <div id="bonusChallengeList"></div>
            <div style="margin-top:2rem;">
                <button class="modal-button cancel-button" onclick="closeModal('bonusChallengeModal')" style="background:#cc2366;color:#fff;">ÿ•ÿ∫ŸÑÿßŸÇ</button>
            </div>
        </div>
    </div>



    <div class="scanner-container" id="scannerModal" style="display: none;">
        <button class="close-button" onclick="closeScanner()">√ó</button>
        <div id="reader"></div>
        <div class="permission-error">
            <h3>ŸÑŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑŸÖÿßÿ≥ÿ≠ ÿßŸÑÿ∂Ÿàÿ¶Ÿäÿå Ÿäÿ¨ÿ® ÿßŸÑÿ≥ŸÖÿßÿ≠ ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß</h3>
            <ol style="text-align: right; margin: 15px 0;">
                <li>ÿßŸÜŸÇÿ± ÿπŸÑŸâ "ÿßŸÑÿ≥ŸÖÿßÿ≠" ŸÅŸä ÿ±ÿ≥ÿßŸÑÿ© ÿ∑ŸÑÿ® ÿßŸÑÿ•ÿ∞ŸÜ</li>
                <li>ÿ•ÿ∞ÿß ŸÑŸÖ ÿ™ÿ∏Ÿáÿ± ÿßŸÑÿ±ÿ≥ÿßŸÑÿ©ÿå ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ™ŸÅÿπŸäŸÑ ÿ•ÿ∞ŸÜ ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß ŸÖŸÜ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ</li>
            </ol>
            <button class="camera-retry-button" onclick="retryCamera()">
                ŸÖÿ≠ÿßŸàŸÑÿ© ÿßŸÑÿ≥ŸÖÿßÿ≠ ŸÑŸÑŸÉÿßŸÖŸäÿ±ÿß
            </button>
        </div>
    </div>

    <div id="purchaseLoading" class="purchase-loading-overlay">
        <div class="purchase-loading-content">
            ÿ¨ÿßÿ±Ÿä ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ∑ŸÑÿ®...<br>
            <div class="cube" style="transform: scale(0.5); margin-top: 20px;">
                <div class="front"></div>
                <div class="back"></div>
                <div class="left"></div>
                <div class="right"></div>
                <div class="top"></div>
                <div class="bottom"></div>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>
        <script type="module">  
    
        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js";
        import { getFirestore, collection, query, where, getDocs, onSnapshot, doc, updateDoc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-firestore.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-auth.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD9B6GcLx_ghzfB6onbGuKWAjtO74Nbyso",
            authDomain: "insta-lkogy-fb20c.firebaseapp.com",
            projectId: "insta-lkogy-fb20c",
            storageBucket: "insta-lkogy-fb20c.firebasestorage.app",
            messagingSenderId: "244190720785",
            appId: "1:244190720785:web:5881602de4b027a26452b0",
            measurementId: "G-SQ0VX5M51D"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        if (localStorage.getItem("login") == "true") {
            document.getElementById("loginContainer").style.display = "none";
            document.querySelector(".container").style.display = "block";
        } else {
            document.getElementById("loginContainer").style.display = "flex";
            document.querySelector(".container").style.display = "none";
        }

        const TEACHER_PASSWORD = localStorage.getItem("password");
        let SECRET_PASSWORD = "";
        const SALT = "insta_lkogy_";
        let cameraInitialized = false;
        let loadedProducts = []; // Stores products after first load
        let productsLoaded = false; // Flag to track if products have been loaded
        const SERVER_TIME_OFFSET = 0; // Will be updated by time sync function
        let productsListener = null;
        document.getElementById("loading-screen").style.display = "flex";

        let state = {
            points: 0,
            activities: [], // Will be filled from Firebase
            history: [],
            password: TEACHER_PASSWORD,
            passwordChanged: false,
            usedQRCodes: new Set()
        };
        
        if (localStorage.getItem("instaLkogyState") != null) {
            let savedState = JSON.parse(localStorage.getItem("instaLkogyState"));
            savedState.activities = state.activities;
            localStorage.setItem("instaLkogyState", JSON.stringify(savedState));
        };

    // Add this function to check auth state
    async function checkAuthState() {
        const username = localStorage.getItem("username");
        const password = localStorage.getItem("password");
        const savedState = localStorage.getItem("instaLkogyState");

        // Always check internet connection FIRST
        if (!navigator.onLine) {
            showOfflineScreen();
            return;
        }

        if (!username) {
            document.getElementById("loginContainer").style.display = "flex";
            document.querySelector(".container").style.display = "none";
            return;
        }

        try {
            const usersRef = collection(db, "users");
            const q = query(usersRef, where("name", "==", username));
            const querySnapshot = await getDocs(q);

            if (!querySnapshot.empty) {
                const userDoc = querySnapshot.docs[0];
                const userData = userDoc.data();
                if (userData.password === password) {
                    document.getElementById("loginContainer").style.display = "none";
                    document.querySelector(".container").style.display = "block";
                    loadState();
                } else {
                    localStorage.removeItem("password");
                    document.getElementById("loginContainer").style.display = "flex";
                    document.querySelector(".container").style.display = "none";
                    document.getElementById("nameLoginInput").value = username;
                }
            } else {
                // No user found in DB, check local recovery data
                if (savedState) {
                    // ONLY show recovery if online
                    showDataRecoveryScreen();
                } else {
                    localStorage.removeItem("username");
                    localStorage.removeItem("password");
                    document.getElementById("loginContainer").style.display = "flex";
                    document.querySelector(".container").style.display = "none";
                }
            }
        } catch (error) {
            // If error (network, etc)
            if (!navigator.onLine) {
                showOfflineScreen(); // Always show offline if not online
            } else if (navigator.onLine && savedState) {
                showDataRecoveryScreen();
            } else {
                showOfflineScreen();
            }
        }
    }

    function showOfflineScreen() {
        // Remove recovery if present (so it's never shown when offline)
        if (document.getElementById("recoveryContainer")) {
            document.getElementById("recoveryContainer").remove();
        }
        // Hide all normal UI
        document.getElementById("loading-screen").style.display = "none";
        document.getElementById("loginContainer").style.display = "none";
        document.querySelector(".container").style.display = "none";
        if (document.getElementById("offlineContainer")) return; // Don't duplicate

        const offlineDiv = document.createElement("div");
        offlineDiv.id = "offlineContainer";
        offlineDiv.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 10000;
            padding: 20px;
            text-align: center;
            font-family: 'Cairo', sans-serif;
        `;
        offlineDiv.innerHTML = `
            <div style="max-width: 600px; width: 100%;">
                <div style="font-size: 80px; margin-bottom: 20px;">üì∂</div>
                <h2 style="color: #FF6B35; margin-bottom: 20px;">ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™</h2>
                <div style="background: rgba(255,107,53,0.1); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                    <p style="font-size: 18px; margin-bottom: 15px;">Ÿäÿ®ÿØŸà ÿ£ŸÜŸÉ ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™</p>
                    <p style="color: #FF914D;">ÿ®ÿ±ÿ¨ÿßÿ° ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßÿ™ÿµÿßŸÑ ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™ ŸàÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ</p>
                </div>
                <button id="retryConnection" style="
                    background: linear-gradient(135deg, #FF6B35, #FF416C);
                    color: white;
                    border: none;
                    padding: 12px 24px;
                    border-radius: 8px;
                    font-size: 16px;
                    cursor: pointer;
                    margin-top: 20px;
                ">ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ</button>
            </div>
        `;
        document.body.appendChild(offlineDiv);
        document.getElementById("retryConnection").addEventListener("click", () => {
            if (navigator.onLine) location.reload();
            else showToast("ŸÑÿß Ÿäÿ≤ÿßŸÑ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ∫Ÿäÿ± ŸÖÿ™ÿßÿ≠", "error");
        });
    }

    function showDataRecoveryScreen() {
        // Hide all normal UI
        document.getElementById("loading-screen").style.display = "none";
        document.getElementById("loginContainer").style.display = "none";
        document.querySelector(".container").style.display = "none";
        if (document.getElementById("recoveryContainer")) return; // Don't duplicate

        const state = JSON.parse(localStorage.getItem("instaLkogyState")) || {};
        const username = localStorage.getItem("username") || "ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ";
        const gender = localStorage.getItem("gender") || "ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ";
        const password = state.password || localStorage.getItem("password") || "none";
        const lkogy = state.points ?? 0;

        const recoveryDiv = document.createElement("div");
        recoveryDiv.id = "recoveryContainer";
        recoveryDiv.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0,0,0,0.95);
          display: flex;
          flex-direction: column;
          justify-content: flex-start;
          align-items: center;
          color: white;
          z-index: 10000;
          padding: 20px;
          text-align: center;
          overflow-y: auto;
          font-family: 'Cairo', sans-serif;
        `;
        recoveryDiv.innerHTML = `
          <div style="max-width: 600px; width: 100%;">
            <h2 style="color: #FF6B35; margin-bottom: 20px;">ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</h2>
            <div style="background: rgba(255,107,53,0.1); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
              <p style="font-size: 18px; margin-bottom: 15px;">Ÿäÿ®ÿØŸà ÿ£ŸÜ ŸáŸÜÿßŸÉ ŸÖÿ¥ŸÉŸÑÿ© ŸÅŸä ÿ≠ÿ≥ÿßÿ®ŸÉÿå ŸÑŸÉŸÜ ŸÑÿØŸäŸÜÿß ÿ®ŸäÿßŸÜÿßÿ™ŸÉ ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ© ÿπŸÑŸâ Ÿáÿ∞ÿß ÿßŸÑÿ¨Ÿáÿßÿ≤</p>
              <p style="color: #FF914D;">ÿ®ÿ±ÿ¨ÿßÿ° ÿ£ÿÆÿ∞ ŸÑŸÇÿ∑ÿ© ÿ¥ÿßÿ¥ÿ© ŸÑŸáÿ∞Ÿá ÿßŸÑÿµŸÅÿ≠ÿ© Ÿàÿ•ÿ±ÿ≥ÿßŸÑŸáÿß ŸÑŸÅÿ±ŸäŸÇ ÿßŸÑÿØÿπŸÖ ŸÑÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿ≠ÿ≥ÿßÿ®ŸÉ</p>
            </div>
            <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: right;">
              <h3 style="color: #FF6B35; border-bottom: 1px solid #FF6B35; padding-bottom: 5px;">ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ©</h3>
              <p><strong>üë§ ÿßŸÑÿßÿ≥ŸÖ:</strong> ${username}</p>
              <p><strong>‚ößÔ∏è ÿßŸÑŸÜŸàÿπ:</strong> ${gender}</p>
              <p><strong>üîí ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±:</strong> ${password}</p>
              <p><strong>üíé ÿ±ÿµŸäÿØ ÿßŸÑŸÑŸÉŸàÿ¨Ÿä:</strong> ${lkogy}</p>
            </div>
          </div>
        `;
        document.body.appendChild(recoveryDiv);
        document.getElementById("retryConnectionRecovery").addEventListener("click", () => {
            if (navigator.onLine) location.reload();
            else showToast("ŸÑÿß Ÿäÿ≤ÿßŸÑ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ∫Ÿäÿ± ŸÖÿ™ÿßÿ≠", "error");
        });
    }

    window.addEventListener("offline", () => {
        showOfflineScreen();
    });
    window.addEventListener("online", () => {
        const offlineDiv = document.getElementById("offlineContainer");
        if (offlineDiv) {
            offlineDiv.remove();
            location.reload();
        }
    });

    // Modify your existing loadState function to handle recovery cases
    async function loadState() {
        const username = localStorage.getItem("username");
        const password = localStorage.getItem("password");
        if (!username || !password) return;

        try {
            // Load points from Firebase
            const userQuery = query(collection(db, "users"), where("name", "==", username));
            const userSnapshot = await getDocs(userQuery);

            if (!userSnapshot.empty) {
                const userDoc = userSnapshot.docs[0];
                state.points = userDoc.data().lkogy || 0;
                document.querySelector('.points-value').textContent = state.points;

                // Load lastUsed timestamps from user's activities subcollection
                const userId = userDoc.id;
                const activitiesDocRef = doc(db, `users/${userId}/activities/activitiesFields`);
                const activitiesSnap = await getDoc(activitiesDocRef);

                let lastUsedMap = {};
                if (activitiesSnap.exists()) {
                    lastUsedMap = activitiesSnap.data();
                }

                // Fetch activities from Firestore
                const tasksRef = collection(db, "tasks");
                const q = query(tasksRef, where("status", "==", "visible"));
                const snapshot = await getDocs(q);

                const today = new Date().getDay();
                const userGender = localStorage.getItem("gender");
                const userStage = await getUserField(username, password, "stage");
                const user = { gender: userGender, stage: userStage };

                state.activities = [];
                snapshot.forEach(doc => {
                    const task = doc.data();
                    if (shouldShowTaskForUser(task, user)) {
                        state.activities.push({
                            id: doc.id,
                            name: task.name,
                            points: task.points,
                            icon: task.icon || '‚úÖ',
                            lastUsed: lastUsedMap[task.name] || null,
                            refreshCycle: task.refreshCycle || 'daily',
                            displayName: task.displayName || task.name,
                            status: task.status || 'visible',
                            activeDays: task.activeDays || [0,1,2,3,4,5,6],
                            gender: task.gender || 'all',
                            stage: task.stage || 'all',
                            isActiveToday: !task.activeDays || task.activeDays.includes(today),
                            order: task.order || 999
                        });
                    }
                });

                // Sort activities
                state.activities.sort((a, b) => (a.order || 999) - (b.order || 999));

                updateUI();
                loadUsers();
            }
        } catch (error) {
            console.error("Error loading state:", error);
            loadStateFromLocalStorage(); // Fallback
        }
    }

    window.addEventListener("load", () => {
        loadStateFromLocalStorage();
        checkAuthState().then(() => {
            if (!document.getElementById("recoveryContainer") && !document.getElementById("offlineContainer")) {
                setTimeout(() => {
                    document.getElementById("loading-screen").classList.add("hide");
                    setTimeout(() => {
                        document.getElementById("loading-screen").style.display = "none";
                    }, 1000);
                }, 2000);
            }
        });
    });


        function getDateTimeFromAPI() {
        fetch("https://api.api-ninjas.com/v1/worldtime?timezone=Africa/Cairo", {
            headers: {
                'X-Api-Key': 'sT9uXKedltExxCv3RbLL1w==EkzBBIf65RkUZ9iG'
            }
        })
        .then((response) => {
            if (!response.ok) {
                throw new Error("Error fetching Time");
            }
            return response.json();
        })
        .then((data) => {
            
            const dateString = `${data.year}-${data.month.toString().padStart(2, '0')}-${data.day.toString().padStart(2, '0')}T${data.hour.toString().padStart(2, '0')}:${data.minute.toString().padStart(2, '0')}:${data.second.toString().padStart(2, '0')}`;
            const apiDate = new Date(dateString);
            
            // Add one hour for DST
            const dstDate = new Date(apiDate.getTime() + (60 * 60 * 1000)); // Add 1 hour in milliseconds
            
            // Now use dstDate instead of fixedDate for your application
            const OriginalDate = Date;
            
            // Get current device date
            const deviceDate = new OriginalDate();
            
            // Calculate difference in milliseconds
            const timeDifference = Math.abs(deviceDate - dstDate);
            const twoHoursInMs = 7200000; // 2 hours in milliseconds

                // Check if device date is outside 2-hours range
                if (timeDifference > twoHoursInMs) {
                    console.warn(`Device time is out of sync! Difference: ${timeDifference/1000/60} minutes`);
                    // You could show a warning to the user here if needed
                    document.body.innerHTML = `
                    <div class="offline-container">
                        <div class="offline-icon">üì∂</div>
                        <h1>ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ™ÿßÿ±ŸäÿÆ</h1>
                        <p>ÿ®ÿ±ÿ¨ÿßÿ° ÿßŸÑÿ™ŸàÿßÿµŸÑ ŸÖÿπ  <a href="https://wa.me/201205814458" target="blank" style="color: #f58f00; text-decoration:  underline #f58f00;font-weight: 900;"> ÿßŸÑÿØÿπŸÖ ÿßŸÑŸÅŸÜŸä</a></p>
                    </div>
                
                    <!-- ÿßŸÑŸÜÿ¨ŸàŸÖ ÿßŸÑÿ¨ŸÖÿßŸÑŸäÿ© -->
                    <div id="stars-container"></div>
                
                    <script>
                        // ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÜÿ¨ŸàŸÖ ÿ®ÿ¥ŸÉŸÑ ÿπÿ¥Ÿàÿßÿ¶Ÿä
                        function createStar() {
                            const star = document.createElement("div");
                            star.classList.add("star");
                            star.innerHTML = "‚≠ê";
                            star.style.left = ${Math.random() * 100}vw; // ŸÖŸàÿ∂ÿπ ÿ£ŸÅŸÇŸä ÿπÿ¥Ÿàÿßÿ¶Ÿä
                            star.style.animationDuration = ${Math.random() * 2 + 1}s; // ÿ≥ÿ±ÿπÿ© ÿ™ÿ≥ÿßŸÇÿ∑ ÿπÿ¥Ÿàÿßÿ¶Ÿäÿ©
                            starsContainer.appendChild(star);
                    
                            // ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑŸÜÿ¨ŸÖ ÿ®ÿπÿØ ÿßŸÜÿ™Ÿáÿßÿ° ÿßŸÑÿ™ÿ≥ÿßŸÇÿ∑
                            star.addEventListener("animationend", () => {
                                star.remove();
                            });
                    
                            // ÿ•ŸÜÿ¥ÿßÿ° ŸÜÿ¨ŸÖ ÿ¨ÿØŸäÿØ ŸÉŸÑ ÿ´ÿßŸÜŸäÿ©
                            setTimeout(createStar, 1000);
                        }
                    
                        // ÿ®ÿØÿ° ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÜÿ¨ŸàŸÖ
                        createStar();
                    `;
                    document.head.innerHTML = `
                        <meta charset="UTF-8">
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <title>ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™</title>
                        <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
                        <style>
                            /* ŸÜŸÅÿ≥ ÿßŸÑÿ£ŸÑŸàÿßŸÜ ŸàÿßŸÑÿ™ÿµŸÖŸäŸÖ ŸÖŸÜ ÿßŸÑŸÉŸàÿØ ÿßŸÑÿ£ÿµŸÑŸä */
                            :root {
                                --primary-color: #FF6B35;
                                --secondary-color: #FF5722;
                                --gradient-start: #833ab4;
                                --gradient-middle: #fd1d1d;
                                --gradient-end: #fcb045;
                                --text-color: #333;
                                --white: #ffffff;
                                --error: #ff3333;
                                --success: #4CAF50;
                                --warning: #ff9800;
                            }
                        
                            * {
                                box-sizing: border-box;
                                margin: 0;
                                padding: 0;
                                font-family: 'Cairo', sans-serif;
                                -webkit-tap-highlight-color: transparent;
                            }
                        
                            body {
                                background: linear-gradient(45deg, var(--gradient-start), var(--gradient-middle), var(--gradient-end));
                                min-height: 100vh;
                                color: var(--text-color);
                                display: flex;
                                justify-content: center;
                                align-items: center;
                                text-align: center;
                                overflow: hidden;
                                position: relative;
                            }
                        
                            .offline-container {
                                background: rgba(255, 255, 255, 0.9);
                                padding: 40px;
                                border-radius: 20px;
                                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
                                max-width: 90%;
                                width: 400px;
                                animation: fadeIn 1s ease-in-out;
                                position: relative;
                                z-index: 2;
                            }
                        
                            @keyframes fadeIn {
                                from { opacity: 0; transform: translateY(-20px); }
                                to { opacity: 1; transform: translateY(0); }
                            }
                        
                            .offline-icon {
                                font-size: 100px;
                                color: var(--error);
                                animation: float 3s ease-in-out infinite;
                            }
                        
                            @keyframes float {
                                0%, 100% { transform: translateY(0); }
                                50% { transform: translateY(-20px); }
                            }
                        
                            h1 {
                                font-size: 2em;
                                margin: 20px 0;
                                color: var(--text-color);
                            }
                        
                            p {
                                font-size: 1.2em;
                                color: #666;
                                margin-bottom: 30px;
                            }
                        
                            /* ÿßŸÑŸÜÿ¨ŸàŸÖ ÿßŸÑÿ¨ŸÖÿßŸÑŸäÿ© */
                            .star {
                                position: absolute;
                                font-size: 30px;
                                color: gold;
                                animation: fall linear infinite;
                                user-select: none;
                                pointer-events: none; /* ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ™ŸÅÿßÿπŸÑ ŸÖÿπ ÿßŸÑŸÜÿ¨ŸàŸÖ */
                                top: -50px; /* ÿ™ÿ®ÿØÿ£ ŸÖŸÜ ŸÅŸàŸÇ ÿßŸÑÿ¥ÿßÿ¥ÿ© */
                            }
                        
                            @keyframes fall {
                                to { transform: translateY(100vh); }
                            }
                        </style>
                    `;
                }            
            
                // Override Date constructor
                window.Date = function (...args) {
                if (args.length === 0) {
                    return new OriginalDate(dstDate);
                }
                return new OriginalDate(...args);
            };
            
            // Keep prototype and static methods
            window.Date.prototype = OriginalDate.prototype;
            Object.setPrototypeOf(window.Date, OriginalDate);
            
            // Optional: Override Date.now()
            Date.now = () => dstDate.getTime();
            
            console.log("Date has been overridden to (DST-adjusted):", new Date());
            
            setTimeout(() => {
                document.getElementById("loading-screen").classList.add("hide");
                setTimeout(() => {
                    document.getElementById("loading-screen").style.display = "none";
                }, 1000);
            }, 3000);
        })
        .catch((error) => {
            console.error("Failed to override Date:", error);

            document.body.innerHTML = `
                <div class="offline-container">
                    <div class="offline-icon">üì∂</div>
                    <h1>ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™</h1>
                    <p>ÿπÿ∞ÿ±Ÿãÿßÿå Ÿäÿ®ÿØŸà ÿ£ŸÜŸÉ ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßÿ™ÿµÿßŸÑŸÉ ŸàÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.</p>
                </div>
            
                <!-- ÿßŸÑŸÜÿ¨ŸàŸÖ ÿßŸÑÿ¨ŸÖÿßŸÑŸäÿ© -->
                <div id="stars-container"></div>
            
                <script>
                    // ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÜÿ¨ŸàŸÖ ÿ®ÿ¥ŸÉŸÑ ÿπÿ¥Ÿàÿßÿ¶Ÿä
                    function createStar() {
                        const star = document.createElement("div");
                        star.classList.add("star");
                        star.innerHTML = "‚≠ê";
                        star.style.left = ${Math.random() * 100}vw; // ŸÖŸàÿ∂ÿπ ÿ£ŸÅŸÇŸä ÿπÿ¥Ÿàÿßÿ¶Ÿä
                        star.style.animationDuration = ${Math.random() * 2 + 1}s; // ÿ≥ÿ±ÿπÿ© ÿ™ÿ≥ÿßŸÇÿ∑ ÿπÿ¥Ÿàÿßÿ¶Ÿäÿ©
                        starsContainer.appendChild(star);
                
                        // ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑŸÜÿ¨ŸÖ ÿ®ÿπÿØ ÿßŸÜÿ™Ÿáÿßÿ° ÿßŸÑÿ™ÿ≥ÿßŸÇÿ∑
                        star.addEventListener("animationend", () => {
                            star.remove();
                        });
                
                        // ÿ•ŸÜÿ¥ÿßÿ° ŸÜÿ¨ŸÖ ÿ¨ÿØŸäÿØ ŸÉŸÑ ÿ´ÿßŸÜŸäÿ©
                        setTimeout(createStar, 1000);
                    }
                
                    // ÿ®ÿØÿ° ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÜÿ¨ŸàŸÖ
                    createStar();
                `;
                document.head.innerHTML = `
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™</title>
                    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
                    <style>
                        /* ŸÜŸÅÿ≥ ÿßŸÑÿ£ŸÑŸàÿßŸÜ ŸàÿßŸÑÿ™ÿµŸÖŸäŸÖ ŸÖŸÜ ÿßŸÑŸÉŸàÿØ ÿßŸÑÿ£ÿµŸÑŸä */
                        :root {
                            --primary-color: #FF6B35;
                            --secondary-color: #FF5722;
                            --gradient-start: #833ab4;
                            --gradient-middle: #fd1d1d;
                            --gradient-end: #fcb045;
                            --text-color: #333;
                            --white: #ffffff;
                            --error: #ff3333;
                            --success: #4CAF50;
                            --warning: #ff9800;
                        }
                    
                        * {
                            box-sizing: border-box;
                            margin: 0;
                            padding: 0;
                            font-family: 'Cairo', sans-serif;
                            -webkit-tap-highlight-color: transparent;
                        }
                    
                        body {
                            background: linear-gradient(45deg, var(--gradient-start), var(--gradient-middle), var(--gradient-end));
                            min-height: 100vh;
                            color: var(--text-color);
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            text-align: center;
                            overflow: hidden;
                            position: relative;
                        }
                    
                        .offline-container {
                            background: rgba(255, 255, 255, 0.9);
                            padding: 40px;
                            border-radius: 20px;
                            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
                            max-width: 90%;
                            width: 400px;
                            animation: fadeIn 1s ease-in-out;
                            position: relative;
                            z-index: 2;
                        }
                    
                        @keyframes fadeIn {
                            from { opacity: 0; transform: translateY(-20px); }
                            to { opacity: 1; transform: translateY(0); }
                        }
                    
                        .offline-icon {
                            font-size: 100px;
                            color: var(--error);
                            animation: float 3s ease-in-out infinite;
                        }
                    
                        @keyframes float {
                            0%, 100% { transform: translateY(0); }
                            50% { transform: translateY(-20px); }
                        }
                    
                        h1 {
                            font-size: 2em;
                            margin: 20px 0;
                            color: var(--text-color);
                        }
                    
                        p {
                            font-size: 1.2em;
                            color: #666;
                            margin-bottom: 30px;
                        }
                    
                        /* ÿßŸÑŸÜÿ¨ŸàŸÖ ÿßŸÑÿ¨ŸÖÿßŸÑŸäÿ© */
                        .star {
                            position: absolute;
                            font-size: 30px;
                            color: gold;
                            animation: fall linear infinite;
                            user-select: none;
                            pointer-events: none; /* ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ™ŸÅÿßÿπŸÑ ŸÖÿπ ÿßŸÑŸÜÿ¨ŸàŸÖ */
                            top: -50px; /* ÿ™ÿ®ÿØÿ£ ŸÖŸÜ ŸÅŸàŸÇ ÿßŸÑÿ¥ÿßÿ¥ÿ© */
                        }
                    
                        @keyframes fall {
                            to { transform: translateY(100vh); }
                        }
                    </style>
                `;
        });
    }
        //  window.addEventListener("load", () => {
        //      getDateTimeFromAPI();
        //  });
        //  setInterval(() => {
        //      getDateTimeFromAPI();            
        //  }, 300000);


            setTimeout(() => {
                 document.getElementById("loading-screen").classList.add("hide");
                 setTimeout(() => {
                     document.getElementById("loading-screen").style.display = "none";
                     // document.getElementById("content").style.display = "block";
                 }, 1000); // Wait for fade-out transition
                }, 5000) // Keep the loading screen for at least 5 seconds;

        async function initializeUserData() {
            const username = localStorage.getItem("username");
            const password = localStorage.getItem("password");

            if (username && password) {
                const userId = await getUserIdByCredentials(username, password);
                if (userId) {
                    await fetchLastUsed(userId);
                    // await syncTimeWithServer();
                }
            }
        }

        async function fetchLastUsed(userId) {
            try {
                const activitiesDocRef = doc(db, `users/${userId}/activities/activitiesFields`);
                const docSnap = await getDoc(activitiesDocRef);
            
                if (!docSnap.exists()) {
                    console.log("No activities found - initializing new record");
                    return;
                }
            
                const activitiesFromDB = docSnap.data();

                // Update state with fresh data from Firestore
                state.activities = state.activities.map(activity => {
                    return {
                        ...activity,
                        lastUsed: activitiesFromDB[activity.name] || null
                    };
                });

                console.log("Successfully loaded activities from Firestore");
                updateUI();
            } catch (error) {
                console.error("Error fetching lastUsed:", error);
            }
        }

function updateHistoryForActivity(activity) {
    // Remove old entries for this activity
    state.history = state.history.filter(item => 
        ((item.activityName !== activity.name) && (item.activityName !== activity.displayName)) || 
        item.points !== activity.points
    );

    if (activity.displayName !== undefined) {
        var acDisplayName = activity.displayName;
    }

    // Add new entry if the activity was completed
    if (activity.lastUsed) {
        state.history.unshift({
            id: activity.lastUsed,
            activityName: acDisplayName || activity.name,
            points: activity.points,
            timestamp: new Date(activity.lastUsed).toLocaleString('ar-EG'),
            type: 'earn'
        });
    }
}


        // Cache for user data
        let cachedUsers = null;

        // Function to load users with caching
        async function loadUsers() {
            const tbody = document.querySelector("#usersTable tbody");
            tbody.innerHTML = "";

            if (cachedUsers) {
                renderUsers(cachedUsers);
                return;
            }

            try {
                const usersRef = collection(db, "users");
                const snapshot = await getDocs(usersRef);

                cachedUsers = snapshot.docs
                    .map(doc => doc.data())
                    .sort((a, b) => (b.lkogy || 0) - (a.lkogy || 0))
                    .slice(0, 5);

                renderUsers(cachedUsers);
            } catch (error) {
                console.error("ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ:", error);
                showToast("ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ", "error");
            }
        }

        // Function to render users
        function renderUsers(users) {
            const tbody = document.querySelector("#usersTable tbody");
            tbody.innerHTML = users.map((user, index) => `
                <tr data-gender="${user.gender}" data-stage="${user.stage}">
                    <td style="font-weight: 900;">#${index + 1}</td>
                    <td>${user.name}</td>
                    <td>${user.lkogy || 0}</td>
                </tr>
            `).join("");
        }

        // Function to get user points with caching
        // async function getUserPoints(username) {
        //     if (state.points && localStorage.getItem("username") === username) {
        //         document.querySelector(".points-value").textContent = state.points;
        //         return;
        //     }

        //     try {
        //         const userQuery = collection(db, "users");
        //         const q = query(userQuery, where("name", "==", username));
        //         const querySnapshot = await getDocs(q);

        //         if (!querySnapshot.empty) {
        //             const userDoc = querySnapshot.docs[0];
        //             const userData = userDoc.data();
        //             document.querySelector(".points-value").textContent = userData["lkogy"];
        //             state.points = userData["lkogy"];
        //         }
        //     } catch (error) {
        //         console.error("Error fetching user points:", error);
        //         showToast("ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÜŸÇÿßÿ∑", "error");
        //     }
        // }
 async function loadActivitiesFromFirebase() {
    try {
        const tasksRef = collection(db, "tasks");
        const q = query(tasksRef, where("status", "==", "visible"));
        const snapshot = await getDocs(q);
        const today = new Date().getDay();

        // Get user info
        const username = localStorage.getItem("username");
        const password = localStorage.getItem("password");
        const userGender = localStorage.getItem("gender");
        const userStage = await getUserField(username, password, "stage");
        const user = { gender: userGender, stage: userStage };

        state.activities = [];
        snapshot.forEach(doc => {
            const task = doc.data();
            if (shouldShowTaskForUser(task, user)) {
                state.activities.push({
                    id: doc.id,
                    name: task.name,
                    points: task.points,
                    icon: task.icon || '‚úÖ',
                    lastUsed: null,
                    refreshCycle: task.refreshCycle || 'daily',
                    displayName: task.displayName || task.name,
                    status: task.status || 'visible',
                    activeDays: task.activeDays || [0,1,2,3,4,5,6],
                    gender: task.gender || 'all',
                    stage: task.stage || 'all',
                    isActiveToday: !task.activeDays || task.activeDays.includes(today),
                    order: task.order || 999
                });
            }
        });
        
        // Sort activities by order field in ascending order
        state.activities.sort((a, b) => (a.order || 999) - (b.order || 999));
        
        // Reset activities if needed
        await resetDailyActivities();
        
        updateUI();
    } catch (error) {
        console.error('Error loading activities:', error);
    }
}

// Call this when the app loads
window.addEventListener('load', () => {
    loadState();
    loadActivitiesFromFirebase();
    // ... other initialization code ...
});
        // Function to update Firestore with batched writes
        export async function updateFirestoreValueByAuth(username, password, fieldName, newValue) {
            try {
                // Detect if the function is being executed from the console
                const error = new Error();
                const stackTrace = error.stack;
            
                if (stackTrace.includes("at eval") || stackTrace.includes("at global") || stackTrace.includes("blob:")) {
                    console.warn("‚ùå Unauthorized attempt to call updateFirestoreValueByAuth from the console!");
                    return;
                }
            
                const collRef = collection(db, "users");
                const q = query(collRef, where("name", "==", username), where("password", "==", password));
                const querySnapshot = await getDocs(q);
            
                if (!querySnapshot.empty) {
                    const userDoc = querySnapshot.docs[0];
                    const docRef = doc(db, "users", userDoc.id);
                    await updateDoc(docRef, { [fieldName]: newValue });
                    console.log("‚úÖ Firestore document updated successfully!");
                } else {
                    console.log("‚ùå No matching user found!");
                }
            } catch (error) {
                console.error("‚ùå Error updating document:", error);
            }
        }

        // import {setDoc } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-firestore.js";

        export async function updateFirestoreValueByAuth2(username, password, activityName, lastUsed) {
            try {
                // Detect if the function is being executed from the console
                const error = new Error();
                const stackTrace = error.stack;
            
                if (stackTrace.includes("at eval") || stackTrace.includes("at global") || stackTrace.includes("blob:")) {
                    console.warn("‚ùå Unauthorized attempt to call updateFirestoreValueByAuth2 from the console!");
                    return;
                }
            
                // Step 1: Find the user document using username and password
                const usersRef = collection(db, "users");
                const q = query(usersRef, where("name", "==", username), where("password", "==", password));
                const querySnapshot = await getDocs(q);
            
                if (!querySnapshot.empty) {
                    const userDoc = querySnapshot.docs[0];  // Get first matching document
                    const userId = userDoc.id;  // Extract document ID
                
                    // Step 2: Reference the nested subcollection and document
                    const activityRef = doc(db, `users/${userId}/activities/activitiesFields`);
                
                    // Step 3: Save the activity data inside the nested document
                    await setDoc(activityRef, {
                        [activityName]: lastUsed  // Store activity name and lastUsed inside activitiesFields
                    }, { merge: true }); // Merge to avoid overwriting existing data
                
                    console.log(`‚úÖ Activity "${activityName}" saved successfully in Firestore under user ${userId}`);
                } else {
                    console.log("‚ùå User not found or incorrect credentials.");
                }
            } catch (error) {
                console.error("‚ùå Error saving activity:", error);
            }
        }

        async function updateFirestoreValueByAuth3(username, password, activityName, lastUsed) {
            try {
                // Detect if the function is being executed from the console
                const error = new Error();
                const stackTrace = error.stack;
            
                if (stackTrace.includes("at eval") || stackTrace.includes("at global") || stackTrace.includes("blob:")) {
                    console.warn("‚ùå Unauthorized attempt to call updateFirestoreValueByAuth2 from the console!");
                    return;
                }
            
                // Step 1: Find the user document using username and password
                const usersRef = collection(db, "users");
                const q = query(usersRef, where("name", "==", username), where("password", "==", password));
                const querySnapshot = await getDocs(q);
            
                if (!querySnapshot.empty) {
                    const userDoc = querySnapshot.docs[0];  // Get first matching document
                    const userId = userDoc.id;  // Extract document ID
                
                    // Step 2: Reference the nested subcollection and document
                    const activityRef = doc(db, `users/${userId}/bonusChallenges/challengesRestrigations`);
                
                    // Step 3: Save the activity data inside the nested document
                    await setDoc(activityRef, {
                        [activityName]: lastUsed  // Store activity name and lastUsed inside activitiesFields
                    }, { merge: true }); // Merge to avoid overwriting existing data
                
                    console.log(`‚úÖ Activity "${activityName}" saved successfully in Firestore under user ${userId}`);
                } else {
                    console.log("‚ùå User not found or incorrect credentials.");
                }
            } catch (error) {
                console.error("‚ùå Error saving activity:", error);
            }
        }

        //window.updateFirestoreValueByAuth2 = updateFirestoreValueByAuth2;
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.backgroundColor = type === 'error' ? 'rgba(255, 51, 51, 0.9)' : 'rgba(0, 0, 0, 0.8)';
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }

        function sanitizeInput(input) {
            return String(input).replace(/[<>]/g, '');
        }

        function validateNumber(input) {
            return /^\d+$/.test(input) && parseInt(input) > 0;
        }


//         async function loadState() {
//     const username = localStorage.getItem("username");
//     if (!username) return;

//     try {
//         // Load points from Firebase
//         const userQuery = query(collection(db, "users"), where("name", "==", username));
//         const userSnapshot = await getDocs(userQuery);

//         if (!userSnapshot.empty) {
//             state.points = userSnapshot.docs[0].data().lkogy || 0;
//             document.querySelector('.points-value').textContent = state.points;
            
//             // Sync activities (will preserve unrelated history)
//             await fetchLastUsed(userSnapshot.docs[0].id);
//         }

//         updateUI();
//         loadUsers();

//     } catch (error) {
//         console.error("Error loading state:", error);
//         loadStateFromLocalStorage(); // Fallback
//     }
// }
        // Function to load state from localStorage
        function loadStateFromLocalStorage() {
    const savedState = localStorage.getItem('instaLkogyState');
    if (savedState) {
        try {
            const parsedState = JSON.parse(savedState);
            state = {
                ...state, // Default values
                ...parsedState, // Override with saved values
                usedQRCodes: new Set(parsedState.usedQRCodes || []), // Convert array back to Set
                history: parsedState.history || [] // Load history from localStorage
            };
        
            // If history is empty, loop through activities and add to history if lastUsed is not null
            if (state.history.length === 0) {
                state.activities.forEach(activity => {
                    if (activity.lastUsed != null) {
                        state.history.push({
                            id: activity.id,
                            activityName: activity.name,
                            points: activity.points,
                            timestamp: new Date(activity.lastUsed).toLocaleString('ar-EG'),
                            type: 'earn'
                        });
                    }
                });
            }
        
            console.log("‚úÖ State loaded from localStorage:", state);
        } catch (error) {
            console.error("‚ùå Error parsing state from localStorage:", error);
        }
    } else {
        console.log("‚ÑπÔ∏è No saved state found in localStorage, using default state.");
    }
}
        function checkInternet() {
            if (!navigator.onLine) {
                showToast("ÿ®ÿ±ÿ¨ÿßÿ° ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ£ÿ™ÿµÿßŸÑ ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™", "error");
            }
        }

        // Run on page load
        window.addEventListener("load", checkInternet);

        // Run when the internet status changes
        window.addEventListener("offline", () => showToast("‚ö†Ô∏è ÿ™ŸÖ ŸÅŸÇÿØ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™", "error"));
        window.addEventListener("online", () => showToast("‚úÖ ÿ™ŸÖÿ™ ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™", "success"));

        // Function to reset lastUsed values at the start of a new day
        async function resetDailyActivities() {
            try {
                const now = new Date();
                const today = new Date();
                today.setHours(0, 0, 0, 0); // Set to midnight in local time
                
                const username = localStorage.getItem("username");
                const password = localStorage.getItem("password");

                if (!username || !password) return;

                const userId = await getUserIdByCredentials(username, password);
                if (!userId) return;

                for (const activity of state.activities) {
                    if (activity.lastUsed) {
                        const lastUsed = new Date(activity.lastUsed);
                        lastUsed.setHours(0, 0, 0, 0); // Normalize to midnight for comparison
                        
                        if (activity.refreshCycle === 'daily' && lastUsed < today) {
                            // Reset if last used was before today
                            activity.lastUsed = null;
                            await updateFirestoreValueByAuth2(
                                username, 
                                password, 
                                activity.name, 
                                null
                            );
                        }
                        else if (activity.refreshCycle === '15days') {
                            const timeDiff = now - lastUsed;
                            const daysDiff = timeDiff / (1000 * 60 * 60 * 24);
                            if (daysDiff >= 15) {
                                activity.lastUsed = null;
                                await updateFirestoreValueByAuth2(
                                    username, 
                                    password, 
                                    activity.name, 
                                    null
                                );
                            }
                        }
                    }
                }
            
                saveState();
                updateUI();
            } catch (error) {
                console.error("Error resetting activities:", error);
            }
        }
        // Call resetDailyActivities periodically (e.g., every minute)
        setInterval(resetDailyActivities, 60000);

        async function getUserField(username, password, fieldName) {
            try {
                const usersRef = collection(db, "users");
                const q = query(usersRef, where("name", "==", username), where("password", "==", password));
                const querySnapshot = await getDocs(q);
            
                if (!querySnapshot.empty) {
                    const userDoc = querySnapshot.docs[0];
                    const userData = userDoc.data();
                
                    if (userData.hasOwnProperty(fieldName)) {
                        // console.log(`‚úÖ Field "${fieldName}" found:`, userData[fieldName]);
                        return userData[fieldName];
                    } else {
                        // console.log(`‚ö†Ô∏è Field "${fieldName}" not found for this user.`);
                        return null;
                    }
                } else {
                    // console.log("‚ùå User not found or wrong credentials.");
                    return null;
                }
            } catch (error) {
                // console.error("‚ùå Error fetching field:", error);
                return null;
            }
        }

        // ‚úÖ Make function global so it can be used anywhere
        window.getUserField = getUserField;

    // DOM Elements
    const login_btn = document.getElementById("loginButton");
    const containerMain = document.querySelector(".container");
    const login_container = document.getElementById("loginContainer");
  
    // **Login Function**
    async function Login() {
      const nameInput = document.getElementById("nameLoginInput").value;
      const passwordInput = document.getElementById("passwordLoginInput").value;
      if (!nameInput || !passwordInput) {
        alert("Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßŸÑÿßÿ≥ŸÖ ŸàŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±");
        return;
      }
  
      try {
        // üîç Query Firestore to find the user
        const usersRef = collection(db, "users");
        const q = query(usersRef, where("name", "==", nameInput), where("password", "==", passwordInput));
        const querySnapshot = await getDocs(q);
  
        if (!querySnapshot.empty) {
          // ‚úÖ User Found
          const userDoc = querySnapshot.docs[0];
          const userData = userDoc.data();
  
          // **Save login status in Local Storage**
        if (!window.localStorage.getItem("username")) {
            localStorage.setItem("username", userData.name);
            localStorage.setItem("gender", userData.gender);
            localStorage.setItem("password",passwordInput);
        }else{
            localStorage.clear();
            localStorage.setItem("username", userData.name);
            localStorage.setItem("gender", userData.gender);
            localStorage.setItem("password",passwordInput);
            location.reload();
        };
          localStorage.setItem("login", "true");
          initializeUserData();
          state.points = userData["lkogy"];
          location.reload();
          // **Show main content & hide login**
          const login_container = document.getElementById("loginContainer");
          const containerMain = document.querySelector(".container");
          login_container.style.display = "none";
          containerMain.style.display = "block";

          document.querySelector(".points-value").textContent = userData["lkogy"];
          WaveUser();
        //   alert(`‚úÖ ŸÖÿ±ÿ≠ÿ®ÿßŸã, ${userData.name}! ŸÑÿØŸäŸÉ ${userData["ŸÑŸÉŸàÿ¨Ÿä "] || 0} ŸÜŸÇÿ∑ÿ©.`);
        } else {
        //   alert("‚ùå ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ£Ÿà ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©.");
          showToast("‚ùå ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ£Ÿà ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©.", "error")
    }
      } catch (error) {
        console.error("‚ö†Ô∏è ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ:", error);
      }
    }
    
    export function Logout() {
        localStorage.removeItem("login");
        location.reload();
    }
    
    window.Logout = Logout;
    
    export function LogoutOnchange() {
        localStorage.removeItem("login");
    }
    
    window.LogoutOnchange = LogoutOnchange;
    

    async function checkUserExists() {
    const isLoggedIn = localStorage.getItem("login");
    const username = localStorage.getItem("username");
    const password = localStorage.getItem("password");

    if (!isLoggedIn || !username || !password) {
        LogoutOnchange();
        return;
    }

    // ‚úÖ Show UI first (Don't log out immediately)
    const login_container = document.getElementById("loginContainer");
    const containerMain = document.querySelector(".container");
    login_container.style.display = "none";
    containerMain.style.display = "block";

    try {
        // üîç Check Firebase in the background
        const usersRef = collection(db, "users");
        const q = query(usersRef, where("name", "==", username), where("password", "==", password));
        const querySnapshot = await getDocs(q);

        if (querySnapshot.empty) {
            console.log("‚ùå User not found in Firebase!");
            LogoutOnchange();
            location.reload();
        }
    } catch (error) {
        console.error("‚ö†Ô∏è Firebase error, but keeping user logged in:", error);
        // ‚è≥ Keep user logged in if Firebase fails (internet issue)
    }
}

    // Setup login functionality when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        // DOM Elements
        const login_btn = document.getElementById("loginButton");
        const containerMain = document.querySelector(".container");
        const login_container = document.getElementById("loginContainer");
        const nameInput = document.getElementById("nameLoginInput");
        const passwordInput = document.getElementById("passwordLoginInput");
        
        // Add event listener to login button
        if (login_btn) {
            login_btn.addEventListener("click", Login);
        }
        
        // Add Enter key listeners to inputs
        if (nameInput) {
            nameInput.addEventListener("keypress", function(event) {
                if (event.key === "Enter") {
                    Login();
                }
            });
        }
        
        if (passwordInput) {
            passwordInput.addEventListener("keypress", function(event) {
                if (event.key === "Enter") {
                    Login();
                }
            });
        }
        
        // Run check when the page loads
        if (window.localStorage.getItem("login") == "true") {
            checkUserExists();        
        }
    });

    async function getUserPoints(username) {
        const userQuery = collection(db, "users");  
        const q = query(userQuery, where("name", "==", username));
        const querySnapshot = await getDocs(q);

        if (!querySnapshot.empty) {
            const userDoc = querySnapshot.docs[0];  
            const userData = userDoc.data();
        
            document.querySelector(".points-value").textContent = userData["lkogy"];
            state.points = userData["lkogy"];
            
        }
    }
// import {getDoc} from "https://www.gstatic.com/firebasejs/11.3.1/firebase-firestore.js";

async function getSecretPassword() {
    try {
        const docRef = doc(db, "settings", "deposit_password"); // Reference the document
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
            SECRET_PASSWORD = docSnap.data().password; // Get the password field
        } else {
            console.log("‚ùå Document not found!");
        }
    } catch (error) {
        console.error("error: 3");
    }
}

// Call the function to fetch the password
getSecretPassword();

async function getUserIdByCredentials(username, password) {
    const usersRef = collection(db, "users");
    const q = query(usersRef, where("name", "==", username), where("password", "==", password));
    const querySnapshot = await getDocs(q);

    if (!querySnapshot.empty) {
        const userDoc = querySnapshot.docs[0];  // First matching document
        const userId = userDoc.id;  // Get document ID
        // console.log("‚úÖ User ID:", userId);
        return userId; // Return the document ID
    } else {
        console.log("‚ùå User not found!");
        return null;  // Return null if user not found
    }
}

// ‚úÖ Make it global so you can call it anywhere
window.getUserIdByCredentials = getUserIdByCredentials;

    // Run on page load to refresh points
    window.addEventListener("load", () => {
        const username = localStorage.getItem("username"); // Get stored username
        if (username) {
            getUserPoints(username);
        }
    });


        function playSoundEffect(options = {}) {
            const {
                volume = 1.0,
                loop = false,
                onEnd = null
            } = options;

            const audio = new Audio("new-notification-7-210334.mp3");

            // Set options
            audio.volume = Math.min(Math.max(volume, 0), 1); // Ensure volume is between 0-1
            audio.loop = loop;

            if (onEnd && typeof onEnd === 'function') {
                audio.addEventListener('ended', onEnd);
            }

            // Play and handle potential autoplay restrictions
            const playPromise = audio.play();

            if (playPromise !== undefined) {
                playPromise.catch(error => {
                    console.error("Audio playback failed:", error);
                    // You might want to implement a fallback or user interaction here
                });
            }

            return audio;
        }       

    // Function to update points


    // ‚úÖ Function to update any field in Firestore

// export async function updateFirestoreValueByAuth(username, password, fieldName, newValue) {
//     try {
//         const collRef = collection(db, "users"); // Change "users" to your collection name
//         const q = query(collRef, where("name", "==", username), where("password", "==", password)); // Match both username and password
//         const querySnapshot = await getDocs(q);

//         if (!querySnapshot.empty) {
//             const userDoc = querySnapshot.docs[0];  // Get the first matching document
//             const docRef = doc(db, "users", userDoc.id); // Get its ID dynamically

//             await updateDoc(docRef, { [fieldName]: newValue }); // Update the field
//         } else {
//             console.log("‚ùå No matching user found!");
//         }
//     } catch (error) {
//         console.error("‚ùå Error updating document:", error);
//     }
// }

// // ‚úÖ Make function global so you can call it from anywhere
// window.updateFirestoreValueByAuth = updateFirestoreValueByAuth;


    // Example: Increase points when a button is clicked
    // function NewAddPoints(){
    //     let currentPoints = state.poi;
    //     let newPoints = currentPoints + 10;  // Increase points by 10

    //     const username = localStorage.getItem("username"); // Get stored username
    //     if (username) {
    //         updateUserPoints(username, newPoints);
    //     }
    // };

    // async function updateUserPoints(newPoints) {
    //     const username = localStorage.getItem("username"); // Get logged-in username
    //     if (!username) {
    //         console.log("No username found!");
    //         return;
    //     }

    //     // Find user document in Firestore
    //     const userQuery = collection(db, "users");
    //     const q = query(userQuery, where("name", "==", username));
    //     const querySnapshot = await getDocs(q);

    //     if (!querySnapshot.empty) {
    //         const userDoc = querySnapshot.docs[0];  
    //         const userRef = doc(db, "users", userDoc.id);  

    //         // Update points in Firestore
    //         await updateDoc(userRef, {
    //             "ŸÑŸÉŸàÿ¨Ÿä ": newPoints
    //         });

    //         console.log("Points updated successfully:", newPoints);
    //     } else {
    //         console.log("User not found!");
    //     }
    // }

    
    function saveState() {
        try {
            const stateToSave = {
                ...state,
                usedQRCodes: Array.from(state.usedQRCodes)
            };
            localStorage.setItem('instaLkogyState', JSON.stringify(stateToSave));
        } catch (error) {
            console.error('Error saving state:', error);
            showToast('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™', 'error');
        }
    }


    if (new Date().toDateString().startsWith("Fri")) {
        console.log("Today is Friday");
    }else{
        console.log("Today is NOT Friday");
    }


    function canUseActivity(activity) {
        // First check if activity is active today
        if (!activity.isActiveToday) return false;

        // If never used before, it's available
        if (!activity.lastUsed) return true;

        const now = new Date();
        const lastUsed = new Date(activity.lastUsed);
        
        // Normalize dates to midnight for comparison
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const lastUsedDate = new Date(lastUsed);
        lastUsedDate.setHours(0, 0, 0, 0);

        if (activity.refreshCycle === 'daily') {
            return lastUsedDate < today;
        }
        else if (activity.refreshCycle === '15days') {
            const timeDiff = now - lastUsed;
            const daysDiff = timeDiff / (1000 * 60 * 60 * 24);
            return daysDiff >= 15;
        }

        return true;
    }
    // Check for reset at regular intervals and also when the day changes
 function setupDailyResetCheck() {
    // Check immediately
    resetDailyActivities();
    
    // Then check every 5 minutes (instead of every minute)
    setInterval(resetDailyActivities, 300000);
    
    // Also check when the day changes (midnight)
    const now = new Date();
    const midnight = new Date();
    midnight.setHours(24, 0, 0, 0);
    const msUntilMidnight = midnight - now;
    
    setTimeout(() => {
        resetDailyActivities();
        // Then set up to check every 24 hours
        setInterval(resetDailyActivities, 86400000);
    }, msUntilMidnight);

    // Add visibility change listener to check when app comes to foreground
    document.addEventListener('visibilitychange', () => {
        if (!document.hidden) {
            resetDailyActivities();
        }
    });
}

        export function addPoints(activityId) {
            try {
                const activity = state.activities.find(a => a.id === activityId);
                if (activity && canUseActivity(activity) && document.getElementById("loading-screen").classList.contains("hide")) {
                    state.points += activity.points;
                    
                    // Use current timestamp
                    const timestamp = Date.now();
                    activity.lastUsed = timestamp;
                    
                    // Update points in Firebase
                    updateFirestoreValueByAuth(
                        localStorage.getItem("username"), 
                        localStorage.getItem("password"), 
                        "lkogy", 
                        state.points
                    );
                    
                    // Update lastUsed timestamp in Firebase
                    updateFirestoreValueByAuth2(
                        localStorage.getItem("username"), 
                        localStorage.getItem("password"), 
                        activity.name, 
                        timestamp
                    );
                    
                    state.history.unshift({
                        id: timestamp,
                        activityName: activity.name,
                        points: activity.points,
                        timestamp: new Date(timestamp).toLocaleString('ar-EG'),
                        type: 'earn'
                    });
                    
                    saveState();
                    updateUI();
                    showToast(`ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ${activity.points} ŸÜŸÇÿ∑ÿ© ÿ®ŸÜÿ¨ÿßÿ≠`);
                    loadUsers();
                } else {
                    showToast('ŸÑŸÇÿØ ŸÇŸÖÿ™ ÿ®Ÿáÿ∞ÿß ÿßŸÑŸÜÿ¥ÿßÿ∑ ÿßŸÑŸäŸàŸÖ ÿ®ÿßŸÑŸÅÿπŸÑ', 'error');
                }
            } catch (error) {
                console.error('Error adding points:', error);
                showToast('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÜŸÇÿßÿ∑', 'error');
            }
        }
        window.addPoints = addPoints;
        export function showSpendModal() {
            document.getElementById('spendModal').style.display = 'flex';
            document.getElementById('spendAmount').focus();
        }
        window.showSpendModal = showSpendModal;
        export function showDepositModal() {
            document.getElementById('depositModal').style.display = 'flex';
            document.getElementById('depositAmount').focus();
        }
        window.showDepositModal = showDepositModal;
        export function showSettingsModal() {
            document.getElementById('settingsModal').style.display = 'flex';

        }
        // export function showExchangeModal() {
        //     document.getElementById('exchangeModal').style.display = 'flex';
        // };
        window.showSettingsModal = showSettingsModal;
        export function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';

            if (modalId === 'settingsModal') {
                // Reset settings view to password section
                document.getElementById('settingsPasswordSection').style.display = 'block';
                document.getElementById('settingsContent').style.display = 'none';
                document.getElementById('settingsPassword').value = '';
            }

            // Clear all inputs in the modal
            const modal = document.getElementById(modalId);
            const inputs = modal.getElementsByTagName('input');
            const errors = modal.getElementsByClassName('error-message');

            Array.from(inputs).forEach(input => input.value = '');
            Array.from(errors).forEach(error => error.style.display = 'none');

            // If closing scanner modal, stop the scanner
            if (modalId === 'scannerModal' && html5QrcodeScanner) {
                html5QrcodeScanner.clear().catch(error => {
                    console.error('Error stopping scanner:', error);
                });
                html5QrcodeScanner = null; // Reset scanner;
            }
        }
        window.closeModal = closeModal;

        export function confirmSpend() {
            const amountInput = document.getElementById('spendAmount');
            const amount = parseInt(amountInput.value);
            const errorElement = document.getElementById('spendError');

            if (!validateNumber(amountInput.value)) {
                errorElement.textContent = 'ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿ±ŸÇŸÖ ÿµÿ≠Ÿäÿ≠ ŸÖŸàÿ¨ÿ®';
                errorElement.style.display = 'block';
                return;
            }

            if (amount > state.points) {
                errorElement.textContent = 'ÿ±ÿµŸäÿØŸÉ ÿ∫Ÿäÿ± ŸÉÿßŸÅŸä';
                errorElement.style.display = 'block';
                return;
            }

            try {
                state.points -= amount;
                state.history.unshift({
                    id: Date.now(),
                    activityName: 'ÿµÿ±ŸÅ ŸÑŸÉŸàÿ¨Ÿä',
                    points: -amount,
                    timestamp: new Date().toLocaleString('ar-EG'),
                    type: 'spend'
                });
                saveState();
                updateUI();
                updateFirestoreValueByAuth(localStorage.getItem("username"),localStorage.getItem("password"),"lkogy",state.points);
                loadUsers();
                closeModal('spendModal');
                showToast(`ÿ™ŸÖ ÿµÿ±ŸÅ ${amount} ŸÜŸÇÿ∑ÿ© ÿ®ŸÜÿ¨ÿßÿ≠`);
            } catch (error) {
                console.error('Error spending points:', error);
                showToast('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿµÿ±ŸÅ ÿßŸÑŸÜŸÇÿßÿ∑', 'error');
            }
        }
        window.confirmSpend = confirmSpend;
        export function confirmDeposit() {
            const password = document.getElementById('teacherPassword').value;
            const amountInput = document.getElementById('depositAmount');
            const amount = parseInt(amountInput.value);
            const passwordError = document.getElementById('passwordError');
            const depositError = document.getElementById('depositError');

            if (password !== SECRET_PASSWORD) {
                passwordError.textContent = 'ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©';
                passwordError.style.display = 'block';
                return;
            }

            if (!validateNumber(amountInput.value)) {
                depositError.textContent = 'ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿ±ŸÇŸÖ ÿµÿ≠Ÿäÿ≠ ŸÖŸàÿ¨ÿ®';
                depositError.style.display = 'block';
                return;
            }

            try {
                state.points += amount;
                updateFirestoreValueByAuth(localStorage.getItem("username"),localStorage.getItem("password"),"lkogy",state.points);
                loadUsers();
                state.history.unshift({
                    id: Date.now(),
                    activityName: 'ÿ•ŸäÿØÿßÿπ ŸÑŸÉŸàÿ¨Ÿä',
                    points: amount,
                    timestamp: new Date().toLocaleString('ar-EG'),
                    type: 'earn'
                });
                saveState();
                updateUI();
                closeModal('depositModal');
                showToast(`ÿ™ŸÖ ÿ•ŸäÿØÿßÿπ ${amount} ŸÜŸÇÿ∑ÿ© ÿ®ŸÜÿ¨ÿßÿ≠`);
            } catch (error) {
                console.error('Error depositing points:', error);
                showToast('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ•ŸäÿØÿßÿπ ÿßŸÑŸÜŸÇÿßÿ∑', 'error');
            }
        }
        window.confirmDeposit = confirmDeposit;
        export function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const currentError = document.getElementById('currentPasswordError');
            const newError = document.getElementById('newPasswordError');

            if (currentPassword !== localStorage.getItem("password")) {
                // currentError.textContent = 'ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿßŸÑÿ≠ÿßŸÑŸäÿ© ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©';
                // currentError.style.display = 'block';
                showToast("ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿßŸÑÿ≠ÿßŸÑŸäÿ© ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©", "error");
                return;
            }

            if (newPassword.length < 6) {
                newError.textContent = 'ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿßŸÑÿ¨ÿØŸäÿØÿ© Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ŸÉŸàŸÜ 6 ÿ£ÿ≠ÿ±ŸÅ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ';
                newError.style.display = 'block';
                return;
            }

            state.password = newPassword;
            state.passwordChanged = !state.passwordChanged;
            updateFirestoreValueByAuth(localStorage.getItem("username"),localStorage.getItem("password"),"password",newPassword);
            saveState();
            updatePasswordStatus();
            localStorage.setItem("password",newPassword);
            LogoutOnchange();
            closeModal('settingsModal');
            showToast('ÿ™ŸÖ ÿ™ÿ∫ŸäŸäÿ± ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿ®ŸÜÿ¨ÿßÿ≠');
        }
        window.changePassword = changePassword;
  function updateUI() {
    document.querySelector('.points-value').textContent = state.points;

    const activitiesList = document.getElementById('activitiesList');
    activitiesList.innerHTML = state.activities
        // .filter(activity => activity.isActiveToday) // REMOVE THIS FILTER
        .map(activity => {
            const canUse = canUseActivity(activity);
            if (activity.displayName !== undefined) {
                var acDisplayName = activity.displayName;
            }
            return `
                <button class="button activity-button ${!canUse ? 'completed' : ''}" 
                        onclick="addPoints('${activity.id}')" 
                        ${!canUse ? 'disabled' : ''}>
                    <div>
                        <span class="activity-icon">${activity.icon}</span>
                        ${acDisplayName || activity.name}
                    </div>
                    <span class="badge">+${activity.points}</span>
                </button>
            `;
        }).join('');

    // Rest of the function remains the same...
    const historyList = document.getElementById('historyList');
    historyList.innerHTML = state.history.map(entry => `
        <div class="history-item ${entry.type}">
            <div>
                <div>${sanitizeInput(entry.activityName)}</div>
                <small>${entry.timestamp}</small>
            </div>
            <span class="badge">${entry.points > 0 ? '+' : ''}${entry.points}</span>
        </div>
    `).join('');

    // renderQuestButtons();
  }
        window.onclick = function(event) {
            const modals = document.getElementsByClassName('modal');
            for (let modal of modals) {
                if (event.target === modal) {
                    closeModal(modal.id);
                }
            }
            if (event.target === document.getElementById('scannerModal')) {
                closeScanner();
            }
        }

        export function generateQRCode() {
            const password = document.getElementById('teacherPassword').value;
            const amount = document.getElementById('depositAmount').value;
            const passwordError = document.getElementById('passwordError');
            const errorElement = document.getElementById('depositError');

            if (password !== SECRET_PASSWORD) {
                passwordError.textContent = 'ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©';
                passwordError.style.display = 'block';
                return;
            }

            if (!validateNumber(amount)) {
                errorElement.textContent = 'ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿ±ŸÇŸÖ ÿµÿ≠Ÿäÿ≠ ŸÖŸàÿ¨ÿ®';
                errorElement.style.display = 'block';
                return;
            }

            const qrCodeData = {
                amount: parseInt(amount),
                id: Date.now().toString(),
                type: 'deposit'
            };

            const qrcodeContainer = document.getElementById('qrcode');
            qrcodeContainer.innerHTML = '';

            new QRCode(qrcodeContainer, {
                text: JSON.stringify(qrCodeData),
                width: 200,
                height: 200
            });
        }
        window.generateQRCode = generateQRCode;
        let html5QrcodeScanner = null;

        export async function requestCameraPermission() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                stream.getTracks().forEach(track => track.stop());
                document.querySelector('.permission-error').style.display = 'none';
                return true;
            } catch (error) {
                document.querySelector('.permission-error').style.display = 'block';
                throw error;
            }
        }
        window.requestCameraPermission = requestCameraPermission;

        export async function startScanner() {
            document.getElementById('scannerModal').style.display = 'block';

            try {
                await requestCameraPermission();
                if (!cameraInitialized) {
                    initializeScanner();
                }

                const config = {
                    fps: 10,
                    qrbox: { width: 250, height: 250 }
                };

                await html5QrcodeScanner.start(
                    { facingMode: "environment" },
                    config,
                    onScanSuccess,
                    onScanError
                );

                document.querySelector('.permission-error').style.display = 'none';
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑŸÖÿßÿ≥ÿ≠:', error);
                document.querySelector('.permission-error').style.display = 'block';
                showToast('Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ≥ŸÖÿßÿ≠ ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß ŸÖŸÜ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÖÿ™ÿµŸÅÿ≠', 'error');
            }
        }
        window.startScanner = startScanner
        export function initializeScanner() {
            try {
                if (!html5QrcodeScanner) {
                    html5QrcodeScanner = new Html5Qrcode("reader");
                    cameraInitialized = true;
                }
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑŸÖÿßÿ≥ÿ≠:', error);
                showToast('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑŸÖÿßÿ≥ÿ≠ ÿßŸÑÿ∂Ÿàÿ¶Ÿä', 'error');
            }
        }
        window.initializeScanner = initializeScanner;
        export function closeScanner() {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.stop().then(() => {
                    document.getElementById('scannerModal').style.display = 'none';
                    html5QrcodeScanner = null;
                    cameraInitialized = false;
                }).catch((error) => {
                    console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÖÿßÿ≥ÿ≠:', error);
                    document.getElementById('scannerModal').style.display = 'none';
                    html5QrcodeScanner = null;
                    cameraInitialized = false;
                });
            } else {
                document.getElementById('scannerModal').style.display = 'none';
            }
        }
        window.closeScanner = closeScanner;

        export function onScanSuccess(decodedText, decodedResult) {
            try {
                const qrData = JSON.parse(decodedText);

                if (qrData.type === 'deposit' && !state.usedQRCodes.has(qrData.id)) {
                    state.points += qrData.amount;
                    updateFirestoreValueByAuth(localStorage.getItem("username"),localStorage.getItem("password"),"lkogy",state.points);
                    state.usedQRCodes.add(qrData.id);
                    state.history.unshift({
                        id: Date.now(),
                        activityName: 'ÿ•ŸäÿØÿßÿπ ÿπÿ®ÿ± ÿ®ÿßÿ±ŸÉŸàÿØ',
                        points: qrData.amount,
                        timestamp: new Date().toLocaleString('ar-EG'),
                        type: 'earn'
                    });
                    saveState();
                    updateUI();
                    loadUsers();
                    showToast(`ÿ™ŸÖ ÿ•ŸäÿØÿßÿπ ${qrData.amount} ŸÜŸÇÿ∑ÿ© ÿ®ŸÜÿ¨ÿßÿ≠`);
                    closeScanner();
                } else {
                    showToast('ÿ™ŸÖ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ Ÿáÿ∞ÿß ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ ŸÖŸÜ ŸÇÿ®ŸÑ', 'error');
                }
            } catch (error) {
                showToast('ÿ®ÿßÿ±ŸÉŸàÿØ ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠', 'error');
            }
        }
        window.onScanSuccess = onScanSuccess;
        export function onScanError(err) {
            console.warn(err);
        }
        window.onScanError = onScanError;
        export function updatePasswordStatus() {
            const statusIndicator = document.getElementById('passwordStatus');
            statusIndicator.classList.toggle('changed', state.passwordChanged);
        }
        window.updatePasswordStatus = updatePasswordStatus;
        // loadState();
        // setInterval(resetDailyActivities, 60000);

        // Add these new functions for task management
        const CORE_TASKS = [
            'ÿµŸÑŸäÿ™',
            'ŸÇÿ±ÿ£ÿ™ ÿßŸÑÿ•ŸÜÿ¨ŸäŸÑ',
            'ÿ≠ÿ∂ÿ±ÿ™ ÿßŸÑŸÇÿØÿßÿ≥',
            'ÿ≠ÿ∂ÿ±ÿ™ ŸÖÿØÿßÿ±ÿ≥ ÿßŸÑÿ£ÿ≠ÿØ',
            'ÿ≠ÿ∂ÿ±ÿ™ ÿØÿ±ÿ≥ ÿßŸÑŸÉÿ™ÿßÿ®',
            'ÿßÿπÿ™ÿ±ŸÅÿ™',
            'ÿ≠ÿ∂ÿ±ÿ™ ÿßŸÑÿ™ÿ≥ÿ®ÿ≠ÿ©',
            'ÿπŸÖŸÑÿ™ ÿ≠ÿßÿ¨ÿ© ÿ™ŸÅÿ±ÿ≠ ŸÇŸÑÿ® ÿ±ÿ®ŸÜÿß',
            'ÿµŸàŸÖÿ™',
            'ÿ≠ÿ∂ÿ±ÿ™ ÿßŸÑÿ£ŸÑÿ≠ÿßŸÜ'
        ];

        export function updateTasksList() {
            const tasksList = document.getElementById('tasksList');
            // Sort tasks by order before displaying
            const sortedTasks = [...state.activities].sort((a, b) => a.order - b.order);
            
            tasksList.innerHTML = sortedTasks
            .filter(activity => shouldShowTaskForUser(activity, user))
            .map(activity => {
                const isCore = CORE_TASKS.includes(activity.name);
                if (activity.displayName !== undefined) {
                    var acDisplayName = activity.displayName;
                }
                const dayNames = ['ÿßŸÑÿ£ÿ≠ÿØ', 'ÿßŸÑÿ•ÿ´ŸÜŸäŸÜ', 'ÿßŸÑÿ´ŸÑÿßÿ´ÿßÿ°', 'ÿßŸÑÿ£ÿ±ÿ®ÿπÿßÿ°', 'ÿßŸÑÿÆŸÖŸäÿ≥', 'ÿßŸÑÿ¨ŸÖÿπÿ©', 'ÿßŸÑÿ≥ÿ®ÿ™'];
                const daysText = activity.activeDays ? activity.activeDays.map(d => dayNames[d]).join('ÿå ') : 'ŸÉŸÑ ÿßŸÑÿ£ŸäÿßŸÖ';
                return `
                    <div class="task-item ${isCore ? 'core-task' : ''}">
                        <span class="task-icon">${activity.icon}</span>
                        <div class="task-details">
                            ${acDisplayName || activity.name}
                            ${isCore ? '<span class="core-task-badge">ÿ£ÿ≥ÿßÿ≥Ÿä</span>' : ''}
                            <div>ÿßŸÑŸÜŸÇÿßÿ∑: ${activity.points}</div>
                            <div>ÿßŸÑŸÅÿ¶ÿ©: ${activity.gender || 'ÿßŸÑÿ¨ŸÖŸäÿπ'}</div>
                            <div>ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ©: ${activity.stage || 'ÿßŸÑÿ¨ŸÖŸäÿπ'}</div>
                            <div>ÿßŸÑÿ£ŸäÿßŸÖ: ${daysText}</div>
                            <div>ÿßŸÑÿ≠ÿßŸÑÿ©: ${activity.status === 'visible' ? 'ÿ∏ÿßŸáÿ±ÿ©' : 'ŸÖÿÆŸÅŸäÿ©'}</div>
                            <div>ÿßŸÑÿ™ÿ≠ÿØŸäÿ´: ${activity.refreshCycle === 'daily' ? 'ŸäŸàŸÖŸä' : 'ŸÉŸÑ 15 ŸäŸàŸÖ'}</div>
                            <div>ÿßŸÑÿ™ÿ±ÿ™Ÿäÿ®: ${activity.order || 999}</div>
                        </div>
                        <input type="number" class="task-points" value="${activity.points}"
                            onchange="updateTaskPoints(${activity.id}, this.value)" min="1">
                        ${!isCore ? `<span class="delete-task" onclick="deleteTask(${activity.id})">‚ùå</span>` : ''}
                    </div>
                `;
            }).join('');
        }
        window.updateTasksList = updateTasksList;
        export function updateTaskPoints(taskId, points) {
            points = parseInt(points);
            if (points < 1) {
                showToast('ÿπÿØÿØ ÿßŸÑŸÜŸÇÿßÿ∑ Ÿäÿ¨ÿ® ÿ£ŸÜ ŸäŸÉŸàŸÜ ÿ£ŸÉÿ®ÿ± ŸÖŸÜ ÿµŸÅÿ±', 'error');
                updateTasksList();
                return;
            }

            const activity = state.activities.find(a => a.id === taskId);
            if (activity) {
                activity.points = points;
                saveState();
                updateUI();
            }
        }
        window.updateTaskPoints = updateTaskPoints;
        export function deleteTask(taskId) {
            const activity = state.activities.find(a => a.id === taskId);
            if (activity && !CORE_TASKS.includes(activity.name)) {
                if (activity.displayName !== undefined) {
                    var acDisplayName = activity.displayName;
                }
                if (confirm(`ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ ŸÖŸáŸÖÿ© "${acDisplayName || activity.name}"ÿü`)) {
                    state.activities = state.activities.filter(a => a.id !== taskId);
                    saveState();
                    updateTasksList();
                    updateUI();
                }
            }
        }
        window.deleteTask = deleteTask;
        export function addNewTask() {
            const name = document.getElementById('newTaskName').value.trim();
            const points = parseInt(document.getElementById('newTaskPoints').value);
            const icon = document.getElementById('newTaskIcon').value.trim();

            if (!name || !points || !icon) {
                showToast('ÿ®ÿ±ÿ¨ÿßÿ° ŸÖŸÑÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™', 'error');
                return;
            }

            if (points < 1) {
                showToast('ÿπÿØÿØ ÿßŸÑŸÜŸÇÿßÿ∑ Ÿäÿ¨ÿ® ÿ£ŸÜ ŸäŸÉŸàŸÜ ÿ£ŸÉÿ®ÿ± ŸÖŸÜ ÿµŸÅÿ±', 'error');
                return;
            }

            if (state.activities.some(a => a.name === name)) {
                showToast('Ÿáÿ∞Ÿá ÿßŸÑŸÖŸáŸÖÿ© ŸÖŸàÿ¨ŸàÿØÿ© ÿ®ÿßŸÑŸÅÿπŸÑ', 'error');
                return;
            }

            const newId = Math.max(...state.activities.map(a => a.id)) + 1;
            state.activities.push({
                id: newId,
                name: name,
                points: points,
                icon: icon,
                lastUsed: null,
                status: 'visible', // Always visible
                isActiveToday: true, // Always clickable
                refreshCycle: 'daily', // Always daily
                activeDays: [0,1,2,3,4,5,6] // Always active on all days
            });

            saveState();
            updateTasksList();
            updateUI();

            // Clear form
            document.getElementById('newTaskName').value = '';
            document.getElementById('newTaskPoints').value = '';
            document.getElementById('newTaskIcon').value = '';

            showToast('ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸáŸÖÿ© ÿ®ŸÜÿ¨ÿßÿ≠');
        }
        window.addNewTask = addNewTask;
        export function verifySettingsPassword() {
            const password = document.getElementById('settingsPassword').value;
            if (password === SECRET_PASSWORD) {
                document.getElementById('settingsPasswordSection').style.display = 'none';
                document.getElementById('settingsContent').style.display = 'block';
                updateTasksList();
            } else {
                showToast('ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©', 'error');
            }
        }
        window.verifySettingsPassword = verifySettingsPassword;
        // Add event listener for Enter key in settings password input
        document.getElementById('settingsPassword').addEventListener('keyup', function(event) {
            if (event.key === 'Enter') {
                verifySettingsPassword();
            }
        });

        document.querySelectorAll('.button').forEach(button => {
            button.addEventListener('click', function(e) {
                const ripple = document.createElement('span');
                ripple.classList.add('ripple');
                this.appendChild(ripple);

                const rect = this.getBoundingClientRect();
                const size = Math.max(rect.width, rect.height);
                ripple.style.width = ripple.style.height = size + 'px';

                const x = e.clientX - rect.left - size/2;
                const y = e.clientY - rect.top - size/2;
                ripple.style.left = x + 'px';
                ripple.style.top = y + 'px';

                setTimeout(() => ripple.remove(), 600);
            });
        });

        // Hide loading screen after page loads with smooth fade-out effect
        // window.addEventListener("load", () => {
        //     setTimeout(() => {
        //         document.getElementById("loading-screen").classList.add("hide");
        //         setTimeout(() => {
        //             document.getElementById("loading-screen").style.display = "none";
        //             // document.getElementById("content").style.display = "block";
        //         }, 1000); // Wait for fade-out transition
        //     }, 3000); // Keep the loading screen for at least 3 seconds
        // });
        function WaveUser() {
            const username = localStorage.getItem("username");
            if (username != null) {
                    const newElement = document.createElement("div");
                    newElement.innerText = "Hello, " + username;
                    newElement.style.position = "absolute";
                    newElement.style.top = "30px";
                    newElement.style.left = "20px";
                    newElement.style.background = "linear-gradient(135deg, #FF512F, #DD2476)";
                    newElement.style.background = "-webkit-linear-gradient(135deg, #FF512F, #DD2476)";
                    newElement.style.borderRadius = "14px";
                    newElement.style.color = "white";
                    newElement.style.padding = "10px";
                    document.body.appendChild(newElement);
                    function applyResponsiveStyles() {
                        const screenWidth = window.innerWidth;
                        const EveEle = document.getElementById("Jesus-rise");
                        if (screenWidth <= 320) {
                            EveEle.style.display = "none";
                        } else if (screenWidth <= 350) {
                            newElement.style.top = "40px";
                            newElement.style.left = "2px";
                            newElement.style.fontSize = "12px";
                            newElement.style.padding = "11px";
                            
                            // EveEle.style.display = "block"; RISE
                            EveEle.style.top = "40px";
                            EveEle.style.right = "2px";
                            EveEle.style.fontSize = "12px";
                            EveEle.style.padding = "11px";
                            
                        } else if (screenWidth > 350 && screenWidth < 600) {
                            newElement.style.top = "35px";
                            newElement.style.left = "5px";
                            newElement.style.fontSize = "12px";
                            newElement.style.padding = "11px";

                            // EveEle.style.display = "block"; RISE
                            EveEle.style.top = "35px";
                            EveEle.style.right = "5px";
                            EveEle.style.fontSize = "12px";
                            EveEle.style.padding = "11px";
                        } else if (screenWidth >= 600 && screenWidth < 1024) {
                            newElement.style.top = "35px";
                            newElement.style.left = "20px";
                            newElement.style.fontSize = "13px";
                            newElement.style.padding = "10px";

                            // EveEle.style.display = "block"; RISE
                            EveEle.style.top = "35px";
                            EveEle.style.right = "20px";
                            EveEle.style.fontSize = "13px";
                            EveEle.style.padding = "10px";
                        } else {
                            newElement.style.top = "20px";
                            newElement.style.left = "30px";
                            newElement.style.fontSize = "15px";
                            newElement.style.padding = "12px";

                            // EveEle.style.display = "block"; RISE
                            EveEle.style.top = "20px";
                            EveEle.style.right = "30px";
                            EveEle.style.fontSize = "15px";
                            EveEle.style.padding = "12px";                            
                        }
                    }
                    applyResponsiveStyles();
                    window.addEventListener("resize", applyResponsiveStyles);    
                }else if (username == null && localStorage.getItem("login") == "true") {
                    location.reload();
                }    
        }
        window.addEventListener("load",WaveUser);
        // Call resetDailyActivities on page load
        window.addEventListener("load", () => {
            loadStateFromLocalStorage(); // Load state from localStorage
            resetDailyActivities(); // Reset activities if a new day has started
            loadState(); // Load state from Firebase
            updateUI(); // Update the UI
        });







        // Function to fetch products from Firestore
        async function fetchProducts() {
            // RETURN ALREADY LOADED PRODUCTS IF THEY EXIST
            if (productsLoaded) {
                return loadedProducts;
            }

            try {
                // GET USER'S GENDER FROM FIREBASE
                const username = localStorage.getItem("username");
                const password = localStorage.getItem("password");
                let userGender = null;
                
                if (username && password) {
                    const userData = await getUserField(username, password, "gender");
                    if (userData) {
                        userGender = userData;
                    }
                }

                const productsRef = collection(db, "products");
                const snapshot = await getDocs(productsRef);

                loadedProducts = []; // RESET ARRAY
                
                snapshot.forEach(doc => {
                    const product = doc.data();
                    // ONLY INCLUDE PRODUCT IF:
                    // 1. IT HAS NO GENDER PROPERTY (AVAILABLE TO ALL)
                    // OR
                    // 2. ITS GENDER MATCHES THE USER'S GENDER
                    if (!product.gender || product.gender === userGender) {
                        loadedProducts.push({
                            id: doc.id,
                            ...product
                        });
                    }
                });

                productsLoaded = true; // MARK AS LOADED
                return loadedProducts;
            } catch (error) {
                console.error("ERROR FETCHING PRODUCTS:", error);
                showToast("ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™", "error");
                return []; // RETURN EMPTY ARRAY IF ERROR
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const products = await fetchProducts();
            const ModalButton = document.querySelector(".exchange-button");

            ModalButton.setAttribute("data-length", products.length);

            if (products.length === 0) {
                ModalButton.removeAttribute("data-length");
                document.querySelector(".exchange-button").classList.add("hide-before");
            }
        });

        // Function to render products in the UI
        async function renderProducts(products) {
            const container = document.getElementById('productsContainer');
            container.innerHTML = '';
            
            const ModalButton = document.querySelector(".exchange-button");

            ModalButton.setAttribute("data-length", products.length);

            if (products.length === 0) {
                container.innerHTML = '<p style="color: black; text-align: center;font-size: 20px; font-weight: 900;margin-bottom: 20px;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÖÿ™ÿßÿ≠ÿ© ÿ≠ÿßŸÑŸäÿßŸã</p>';
                ModalButton.removeAttribute("data-length");
                document.querySelector(".exchange-button").classList.add("hide-before");
                return;
            }

            const username = localStorage.getItem("username");
            const password = localStorage.getItem("password");
            const userId = await getUserIdByCredentials(username, password);

            // Get user's orders if logged in
            let userOrders = {};
            if (userId) {
                const ordersRef = doc(db, "users", userId, "orders", "orders");
                const ordersSnap = await getDoc(ordersRef);
                if (ordersSnap.exists()) {
                    userOrders = ordersSnap.data();
                }
            }

            for (const product of products) {
                const productDiv = document.createElement('div');
                productDiv.className = 'product';
                if (product.status === 'out_of_stock') {
                    productDiv.setAttribute('data-status', 'out_of_stock');
                }
                
                // Check if user has already ordered this product
                const isOrdered = userOrders[product.id] !== undefined && userOrders[product.id] !== null;

                // Create product HTML
                productDiv.innerHTML = `
                    <img src="${product.imageUrl || 'web icon-modified.png'}" 
                        alt="${product.name || 'ŸÖŸÜÿ™ÿ¨'}" 
                        style="max-width: 200px; ${product.status === 'out_of_stock' ? 'opacity: 0.5;' : ''}">
                    <p style="display: flex; flex-direction: column; justify-content: center; align-items: center">
                        <span class="ProdName">${product.name || 'ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ™ÿ¨'}</span>
                        <span class="ProdDescription">${product.description || 'ŸàÿµŸÅ ÿßŸÑŸÖŸÜÿ™ÿ¨'}</span>
                    </p>
                `;

                // Add price options if they exist
                if (product.priceOptions && product.priceOptions.length > 0) {
                    const optionsDiv = document.createElement('div');
                    optionsDiv.className = 'price-options';
                    optionsDiv.innerHTML = '<p style="margin-bottom: 5px;">ÿßÿÆÿ™ÿ± ÿßŸÑÿÆŸäÿßÿ±:</p>';
                    
                    product.priceOptions.forEach((option, index) => {
                        const optionBtn = document.createElement('button');
                        optionBtn.className = 'price-option-btn';
                        optionBtn.textContent = `${option.name}: ${option.value} ŸÑŸÉŸàÿ¨Ÿä`;
                        optionBtn.dataset.price = option.value;
                        optionBtn.dataset.optionIndex = index;
                        optionsDiv.appendChild(optionBtn);
                    });
                    
                    productDiv.appendChild(optionsDiv);
                } else {
                    // Single price display
                    const priceP = document.createElement('p');
                    priceP.className = 'ProdPrice';
                    priceP.textContent = `${product.price || 0} ŸÑŸÉŸàÿ¨Ÿä`;
                    productDiv.appendChild(priceP);
                }

                // Add order button
                const orderBtn = document.createElement('button');
                orderBtn.className = 'OrderButton';
                orderBtn.textContent = isOrdered ? 'ÿ™ŸÖ ÿßŸÑÿ∑ŸÑÿ®' : (product.status === 'out_of_stock' ? 'ŸÜŸÅÿ∞ÿ™ ÿßŸÑŸÉŸÖŸäÿ©' : 'ÿ£ÿ∑ŸÑÿ® ÿßŸÑÿ¢ŸÜ');
                orderBtn.disabled = isOrdered || product.status === 'out_of_stock';
                orderBtn.dataset.productId = product.id;
                
                productDiv.appendChild(orderBtn);
                container.appendChild(productDiv);

                // Add event listeners for price options if they exist
                if (product.priceOptions && product.priceOptions.length > 0) {
                    const optionButtons = productDiv.querySelectorAll('.price-option-btn');
                    optionButtons.forEach(btn => {
                        btn.addEventListener('click', function() {
                            // Remove selected class from all buttons
                            optionButtons.forEach(b => b.classList.remove('selected'));
                            // Add selected class to clicked button
                            this.classList.add('selected');
                            // Update order button with selected price
                            orderBtn.dataset.selectedPrice = this.dataset.price;
                            orderBtn.dataset.optionIndex = this.dataset.optionIndex;
                        });
                    });
                    
                    // Select first option by default
                    if (optionButtons.length > 0) {
                        optionButtons[0].click();
                    }
                }
            }

            // Add event listeners to all order buttons
            document.querySelectorAll('.OrderButton:not(:disabled)').forEach(button => {
                button.addEventListener('click', function() {
                    const productId = this.getAttribute('data-product-id');
                    const selectedPrice = this.getAttribute('data-selected-price');
                    const optionIndex = this.getAttribute('data-option-index');
                    orderProduct(productId, selectedPrice, optionIndex);
                });
            });
        }


        // Function to handle product ordering
        async function orderProduct(productId, selectedPrice = null, optionIndex = null) {
            try {
                const loadingOverlay = document.getElementById('purchaseLoading');
                const buyButton = document.querySelector(`.OrderButton[data-product-id="${productId}"]`);
                
                // Show loading screen and disable button
                loadingOverlay.style.display = 'flex';
                buyButton.disabled = true;
                
                const username = localStorage.getItem("username");
                const password = localStorage.getItem("password");
                
                if (!username || !password) {
                    showToast("Ÿäÿ¨ÿ® ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã", "error");
                    loadingOverlay.style.display = 'none';
                    buyButton.disabled = false;
                    return;
                }
                
                // Get user ID
                const userId = await getUserIdByCredentials(username, password);
                if (!userId) {
                    showToast("ÿÆÿ∑ÿ£ ŸÅŸä ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ", "error");
                    loadingOverlay.style.display = 'none';
                    buyButton.disabled = false;
                    return;
                }
                
                // Reference to user's orders document
                const ordersRef = doc(db, "users", userId, "orders", "orders");
                
                // Check if user already ordered this product
                const ordersSnap = await getDoc(ordersRef);
                const currentOrders = ordersSnap.exists() ? ordersSnap.data() : {};
                
                if (currentOrders[productId] !== undefined && currentOrders[productId] !== null) {
                    showToast("ŸÑŸÇÿØ ÿ∑ŸÑÿ®ÿ™ Ÿáÿ∞ÿß ÿßŸÑŸÖŸÜÿ™ÿ¨ ŸÖŸÜ ŸÇÿ®ŸÑ", "error");
                    loadingOverlay.style.display = 'none';
                    return;
                }
                
                // Get the product details
                const productRef = doc(db, "products", productId);
                const productSnap = await getDoc(productRef);
                
                if (!productSnap.exists()) {
                    showToast("ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ", "error");
                    loadingOverlay.style.display = 'none';
                    buyButton.disabled = false;
                    return;
                }
                
                const product = productSnap.data();
                let productPrice = product.price || 0;
                let selectedOptionName = null;
                
                // If price options exist and one is selected, use that price
                if (product.priceOptions && optionIndex !== null) {
                    productPrice = product.priceOptions[optionIndex].value;
                    selectedOptionName = product.priceOptions[optionIndex].name;
                }
                
                // Check if product is available
                if (product.status === 'out_of_stock') {
                    showToast("Ÿáÿ∞ÿß ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ± ÿ≠ÿßŸÑŸäÿßŸã", "error");
                    loadingOverlay.style.display = 'none';
                    buyButton.disabled = false;
                    return;
                }
                
                // Check if product has reached max orders
                if (product.maxOrders > 0 && product.currentOrders >= product.maxOrders) {
                    // Update status to out of stock
                    await updateDoc(productRef, {
                        status: 'out_of_stock',
                        currentOrders: product.currentOrders + 1
                    });
                    showToast("ŸÜŸÅÿ∞ÿ™ ŸÉŸÖŸäÿ© Ÿáÿ∞ÿß ÿßŸÑŸÖŸÜÿ™ÿ¨", "error");
                    loadingOverlay.style.display = 'none';
                    buyButton.disabled = false;
                    return;
                }
                
                // Get user's current points
                const userPoints = await getUserField(username, password, "lkogy");
                
                // if (userPoints < productPrice) {
                //     showToast("ÿ±ÿµŸäÿØŸÉ ÿ∫Ÿäÿ± ŸÉÿßŸÅŸä ŸÑÿ¥ÿ±ÿßÿ° Ÿáÿ∞ÿß ÿßŸÑŸÖŸÜÿ™ÿ¨", "error");
                //     loadingOverlay.style.display = 'none';
                //     buyButton.disabled = false;
                //     return;
                // }
                
                // Deduct points
                const newPoints = userPoints - productPrice;
                if (newPoints < -500){
                    showToast("ŸÑÿß ŸäŸÖŸÉŸÜŸÉ ÿ£ŸÜ ÿ™ŸÉŸàŸÜ ŸÖÿØŸäŸàŸÜ ÿ®ÿ£ŸÉÿ´ÿ± ŸÖŸÜ 500 ŸÑŸÉŸàÿ¨Ÿä", "error");
                    loadingOverlay.style.display = 'none';
                    buyButton.disabled = false;
                    return;
                } else {
                    await updateFirestoreValueByAuth(username, password, "lkogy", newPoints);
                
                    // Prepare order data
                    const orderData = {
                        [productId]: Date.now(), // Store current timestamp
                        [`${productId}_price`]: productPrice, // Store the actual price paid
                    };

                    // If there's a selected option, store it
                    if (selectedOptionName) {
                        orderData[`${productId}_selectedOption`] = selectedOptionName;
                    }

                    // Record the order
                    await setDoc(ordersRef, orderData, { merge: true });

                    // Update product's current orders count if maxOrders is set
                    if (product.maxOrders > 0) {
                        const newCurrentOrders = (product.currentOrders || 0) + 1;

                        // Update product document
                        await updateDoc(productRef, {
                            currentOrders: newCurrentOrders,
                            status: newCurrentOrders >= product.maxOrders ? 'out_of_stock' : 'in_stock'
                        });
                    }

                    // Update UI
                    state.points = newPoints;
                    document.querySelector('.points-value').textContent = newPoints;

                    // Add to history
                    state.history.unshift({
                        id: Date.now(),
                        activityName: `ÿ¥ÿ±ÿßÿ° ${product.name}` + (selectedOptionName ? ` (${selectedOptionName})` : ''),
                        points: -productPrice,
                        timestamp: new Date().toLocaleString('ar-EG'),
                        type: 'spend'
                    }); 

                    saveState();
                    updateUI();
                    loadUsers();

                    // Show success message
                    showToast(`ÿ™ŸÖ ÿ¥ÿ±ÿßÿ° ${product.name}` + (selectedOptionName ? ` (${selectedOptionName})` : '') + ` ÿ®ŸÜÿ¨ÿßÿ≠`, "success");   
                }
                
                // Update the button
                if (buyButton) {
                    buyButton.textContent = "ÿ™ŸÖ ÿßŸÑÿ∑ŸÑÿ®";
                    buyButton.disabled = true;
                    navigator.vibrate?.(200);
                    playSoundEffect();
                }
                
            } catch (error) {
                console.error("Error ordering product:", error);
                showToast("ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿπŸÖŸÑŸäÿ© ÿßŸÑÿ¥ÿ±ÿßÿ°", "error");
                
                // Re-enable the button if there was an error
                const buyButton = document.querySelector(`.OrderButton[data-product-id="${productId}"]`);
                if (buyButton) {
                    buyButton.disabled = false;
                }
            } finally {
                // Hide loading screen when done
                document.getElementById('purchaseLoading').style.display = 'none';
            }
        }
        // Function to load and display products when exchange modal is opened
        export async function showExchangeModal() {
            try {
                document.getElementById('exchangeModal').style.display = 'flex';

                // CREATE ARABIC LOADING ANIMATION
                const container = document.getElementById('productsContainer');
                container.innerHTML = `
                    <div style="
                        color: black;
                        text-align: center;
                        font-size: 1.5em;
                        font-family: 'Cairo', sans-serif;
                        margin: 20px 0;
                    ">
                        ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ<span class="loading-dots"></span>
                    </div>
                `;
                
                // ADD CSS FOR THE LOADING DOTS ANIMATION
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes arabicLoading {
                        0%, 100% { opacity: 0; }
                        50% { opacity: 1; }
                    }
                    .loading-dots::after {
                        content: '...';
                        display: inline-block;
                        animation: arabicLoading 1.5s infinite steps(1);
                    }
                `;
                document.head.appendChild(style);
                
                // LOAD PRODUCTS - FILTERING IS NOW HANDLED IN fetchProducts
                const products = await fetchProducts();
                renderProducts(products);
                
                // REMOVE THE STYLE WHEN DONE
                document.head.removeChild(style);
                
            } catch (error) {
                console.error("ERROR SHOWING EXCHANGE MODAL:", error);
                showToast("ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ŸÅÿ™ÿ≠ ÿßŸÑŸÖÿ™ÿ¨ÿ±", "error");
            }
        }
        window.showExchangeModal = showExchangeModal;

        async function refreshProducts() {
            productsLoaded = false; // Reset the flag to force reload
            loadedProducts = []; // Clear loaded products

            const container = document.getElementById('productsContainer');
            container.innerHTML = '<p style="color: black; text-align: center;font-size: 20px; font-weight: 900;margin-bottom: 20px;">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™...</p>';

            const products = await fetchProducts();
            renderProducts(products);

            showToast("ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™", "success");
        }

        // Add this to your settings or as a refresh button






        function Order() {
            navigator.vibrate?.(200)
            showToast("ÿ™ŸÖ ÿ∑ŸÑÿ® ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿ®ŸÜÿ¨ÿßÿ≠ ‚úÖ","success");
            this.disabled = true;
            this.textContent = "ÿ™ŸÖ ÿßŸÑÿ∑ŸÑÿ®";
        };

        document.querySelectorAll('.product button').forEach(BuyButton => {
            BuyButton.addEventListener("click", Order);
        });

        async function setupProductsListener() {
            if (productsListener) {
                productsListener(); // UNSUBSCRIBE FROM PREVIOUS LISTENER IF EXISTS
            }
            
            // GET USER'S GENDER FROM FIREBASE
            const username = localStorage.getItem("username");
            const password = localStorage.getItem("password");
            let userGender = null;
            
            if (username && password) {
                const userData = await getUserField(username, password, "gender");
                if (userData) {
                    userGender = userData;
                }
            }

            const productsRef = collection(db, "products");
            productsListener = onSnapshot(productsRef, (snapshot) => {
                loadedProducts = [];
                
                snapshot.forEach(doc => {
                    const product = doc.data();
                    // APPLY THE SAME FILTERING LOGIC
                    if (!product.gender || product.gender === userGender) {
                        loadedProducts.push({
                            id: doc.id,
                            ...product
                        });
                    }
                });
                
                // IF EXCHANGE MODAL IS OPEN, REFRESH THE PRODUCTS DISPLAY
                if (document.getElementById('exchangeModal').style.display === 'flex') {
                    renderProducts(loadedProducts);
                }
            });
        }
        // Call this when the page loads
        window.addEventListener("load", () => {
            setupProductsListener();
        });


        window.showBonusChallengeModal = async function() {
    document.getElementById('bonusChallengeModal').style.display = 'flex';
    await loadBonusChallenges();
};

async function getChallengeNameById(challengeId) {
    const db = getFirestore();
    try {
        const challengeDoc = await getDoc(doc(db, "bonusChallenges", challengeId));
        if (challengeDoc.exists()) {
            return challengeDoc.data().name || null;
        } else {
            return null;
        }
    } catch (err) {
        console.error("Error fetching challenge:", err);
        return null;
    }
}

async function loadBonusChallenges() {
    const challengeList = document.getElementById("bonusChallengeList");
    challengeList.innerHTML = `<div style="text-align:center; margin:20px 0;">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</div>`;

    const db = getFirestore();
    const username = localStorage.getItem("username") || "";
    const userStage = localStorage.getItem("stage")
        || await getUserField(username, localStorage.getItem("password"), "stage") || "first";
    const userGender = localStorage.getItem("gender") || "Male";

    // Get user doc (for doneChallenges)
    let userDocSnap = await getDocs(query(collection(db, "users"), where("name", "==", username)));
    let userData = userDocSnap.docs[0]?.data();
    let doneChallenges = userData?.doneChallenges || [];

    // Get all user registrations
    let regSnaps = await getDocs(query(collection(db, "registrations"), where("username", "==", username)));
    let regByChallenge = {};
    regSnaps.forEach(doc => {
        const reg = doc.data();
        regByChallenge[reg.challengeId] = reg.status || "pending";
    });

    // Load all challenges
    const challengesRef = collection(db, "bonusChallenges");
    const snapshot = await getDocs(challengesRef);

    let html = "";
    let processed = 0;

    for (const docSnap of snapshot.docs) {
        const data = docSnap.data();
        const challengeId = docSnap.id;

        if (!data.isAvailable) continue;
        if (data.stage !== "all" && data.stage !== userStage) continue;
        if (data.gender !== "all" && data.gender !== userGender) continue;

        let hasWon = doneChallenges.includes(challengeId);
        let regStatus = regByChallenge[challengeId];
        
        console.log(`Challenge ${challengeId}: hasWon=${hasWon}, regStatus=${regStatus}`);

        // Eligibility: (optional, for advanced sequencing)
        let eligible = true; // If you want to restrict by levels, add logic here

        // Button state
        let btnText = "ÿßŸÜÿ∂ŸÖ ŸÑŸÑÿ™ÿ≠ÿØŸä", btnDisabled = false, btnColor = "#fff", btnTextColor = "#cc2366";
        if (hasWon) {
            btnText = "‚úîÔ∏è ÿ™ŸÖ ÿßŸÑŸÅŸàÿ≤"; btnDisabled = true; btnColor = "#4caf50"; btnTextColor = "#fff";
            console.log(`Challenge ${challengeId}: Button disabled (hasWon)`);
        } else if (regStatus) {
            if (regStatus === "done") {
                btnText = "‚úîÔ∏è ÿ™ŸÖ ÿßŸÑŸÅŸàÿ≤"; 
                btnDisabled = true; 
                btnColor = "#4caf50"; 
                btnTextColor = "#fff";
                console.log(`Challenge ${challengeId}: Button disabled (done)`);
            } else if (regStatus === "refused") {
                btnText = "‚ùå ŸÖÿ±ŸÅŸàÿ∂"; 
                btnDisabled = false; 
                btnColor = "#ff3333"; 
                btnTextColor = "#fff";
                console.log(`Challenge ${challengeId}: Button enabled (refused)`);
            } else {
                btnText = "‚è≥ ÿ®ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑŸÖŸàÿßŸÅŸÇÿ©";
                btnDisabled = true;
                btnColor = "#ff9800";
                btnTextColor = "#fff";
                console.log(`Challenge ${challengeId}: Button disabled (pending)`);
            }
        } else {
            console.log(`Challenge ${challengeId}: Button enabled (no registration)`);
        }

        html += `
        <div class="challenge-card" style="background:rgba(255,255,255,0.15);border-radius:1rem;padding:1.5rem;margin-bottom:1rem;box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
          <h3 style="color:#dc2743">${data.name}</h3>
          <p>${data.desc}</p>
          <p>ŸÑŸÉŸàÿ¨Ÿä: <b style="color:#cc2366">${data.reward}</b></p>
          <button
            style="margin-top:.5rem; background:${btnColor};color:${btnTextColor};font-weight:bold;padding:0.75rem 1.25rem;border-radius:1rem;border:none;cursor:${btnDisabled?'not-allowed':'pointer'};box-shadow:0 4px 15px rgba(0,0,0,0.2);transition:.3s;"
            ${btnDisabled ? 'disabled' : ''}
            data-challenge-id="${challengeId}"
          >
            ${btnText}
          </button>
        </div>
        `;
        processed++;
    }

    challengeList.innerHTML = processed ? html : `<div style="text-align:center;color:#cc2366;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ™ÿ≠ÿØŸäÿßÿ™ ŸÖÿ™ÿßÿ≠ÿ© ÿ≠ÿßŸÑŸäÿßŸã</div>`;

    // Add event listeners to join buttons
    console.log('Setting up event listeners for normal challenge buttons...');
    const allButtons = challengeList.querySelectorAll('button[data-challenge-id]');
    console.log('Total buttons with data-challenge-id:', allButtons.length);
    const normalButtons = challengeList.querySelectorAll('button[data-challenge-id]:not([disabled])');
    console.log('Found normal challenge buttons (not disabled):', normalButtons.length);
    
    // Debug: Log all buttons and their disabled state
    allButtons.forEach((btn, index) => {
        console.log(`Button ${index}:`, btn.textContent.trim(), 'disabled:', btn.disabled, 'has disabled attr:', btn.hasAttribute('disabled'));
    });
    
    Array.from(normalButtons).forEach(btn => {
        console.log('Adding event listener to button:', btn.textContent.trim());
        btn.addEventListener('click', async function() {
            console.log('Normal challenge button clicked!');
            const challengeId = btn.getAttribute('data-challenge-id');
            const regStatus = regByChallenge[challengeId];
            
            // If previously refused, allow re-registration
            if (regStatus === "refused") {
                btn.disabled = true;
                btn.textContent = "‚è≥ ÿ¨ÿßÿ±Ÿä ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ...";
                try {
                    // Update existing registration to pending
                    const regQuery = query(collection(db, "registrations"), 
                        where("challengeId", "==", challengeId), 
                        where("username", "==", username));
                    const regSnapshot = await getDocs(regQuery);
                    
                    if (!regSnapshot.empty) {
                        await updateDoc(doc(db, "registrations", regSnapshot.docs[0].id), {
                            status: "pending",
                            timestamp: new Date()
                        });
                    }
                    
                    alert("ÿ™ŸÖ ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿ®ŸÜÿ¨ÿßÿ≠! ÿ®ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑŸÖŸàÿßŸÅŸÇÿ©");
                    await loadBonusChallenges();
                } catch (e) {
                    alert("ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ");
                    console.error(e);
                    btn.disabled = false;
                    btn.textContent = '‚ùå ŸÖÿ±ŸÅŸàÿ∂';
                }
            } else {
                // New registration
                btn.disabled = true;
                btn.textContent = "‚è≥ ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ...";
                try {
                    // Register the user for the challenge
                    await setDoc(doc(collection(db, "registrations")), {
                        challengeId,
                        username,
                        status: "pending",
                        timestamp: new Date()
                    });
                    
                    // Also update the user's bonus challenges tracking
                    await updateFirestoreValueByAuth3(localStorage.getItem("username"), localStorage.getItem("password"), await getChallengeNameById(challengeId), challengeId);
                    
                    alert("ÿ™ŸÖ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿ®ŸÜÿ¨ÿßÿ≠! ÿ®ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑŸÖŸàÿßŸÅŸÇÿ©");
                    await loadBonusChallenges();
                } catch (e) {
                    alert("ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ");
                    console.error(e);
                    btn.disabled = false;
                    btn.textContent = 'ÿßŸÜÿ∂ŸÖ ŸÑŸÑÿ™ÿ≠ÿØŸä';
                }
            }
        });
    });
}

// --- CHAIN CHALLENGES FEATURE START ---
async function loadChainChallenges() {
    console.log('=== loadChainChallenges called ===');
    const db = getFirestore();
    const username = localStorage.getItem("username") || "";
    
    // Get user's chain registrations
    let userChainRegs = await getDocs(query(collection(db, "chainRegistrations"), where("username", "==", username)));
    let userChainStatus = {};
    userChainRegs.forEach(doc => {
        const reg = doc.data();
        const key = `${reg.chainId}_${reg.level}`;
        userChainStatus[key] = reg.status || "pending";
    });

    // Get all challenge chains
    const chainsRef = collection(db, "challengeChains");
    const chainsSnapshot = await getDocs(chainsRef);
    
    let chainsHtml = "";
    let processedChains = 0;

    for (const chainDoc of chainsSnapshot.docs) {
        const chainData = chainDoc.data();
        const chainId = chainDoc.id;
        
        if (!chainData.dayChallenges || chainData.dayChallenges.length === 0) continue;
        
        let chainHtml = `
        <div class="chain-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 1rem; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 8px 25px rgba(0,0,0,0.3);">
          <h3 style="color: white; margin-bottom: 0.5rem;">
            <i class="fas fa-link" style="margin-left: 0.5rem; color: #ffd700;"></i> ${chainData.name}
          </h3>
          <p style="color: rgba(255,255,255,0.9); margin-bottom: 1rem;">${chainData.description}</p>
          <div style="display: flex; flex-direction: column; gap: 0.8rem;">
        `;
        
        // Show challenges based on user's progress
        let highestCompletedLevel = 0;
        for (let i = 0; i < chainData.dayChallenges.length; i++) {
            const key = `${chainId}_${i + 1}`;
            const status = userChainStatus[key];
            if (status === "done") {
                highestCompletedLevel = i + 1;
            }
        }
        
        // Show available challenges (first level + any completed previous levels)
        for (let i = 0; i < chainData.dayChallenges.length; i++) {
            const challenge = chainData.dayChallenges[i];
            const level = i + 1;
            const key = `${chainId}_${level}`;
            const status = userChainStatus[key];
            
            // Only show if it's the first level or previous level is completed
            if (level === 1 || (level > 1 && userChainStatus[`${chainId}_${level - 1}`] === "done")) {
                let btnText = "ÿßŸÜÿ∂ŸÖ ŸÑŸÑÿ™ÿ≠ÿØŸä", btnDisabled = false, btnColor = "#fff", btnTextColor = "#667eea";
                
                if (status === "done") {
                    btnText = "‚úîÔ∏è ÿ™ŸÖ ÿßŸÑŸÅŸàÿ≤"; 
                    btnDisabled = true; 
                    btnColor = "#4caf50"; 
                    btnTextColor = "#fff";
                } else if (status === "pending") {
                    btnText = "‚è≥ ÿ®ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑŸÖŸàÿßŸÅŸÇÿ©";
                    btnDisabled = true;
                    btnColor = "#ff9800";
                    btnTextColor = "#fff";
                } else if (status === "refused") {
                    btnText = "‚ùå ŸÖÿ±ŸÅŸàÿ∂"; 
                    btnDisabled = false; 
                    btnColor = "#ff3333"; 
                    btnTextColor = "#fff";
                }
                
                chainHtml += `
                <div style="background: rgba(255,255,255,0.1); border-radius: 0.8rem; padding: 1rem; backdrop-filter: blur(10px);">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <h4 style="color: white; margin: 0;">ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ ${level}: ${challenge.name}</h4>
                    <span style="color: #ffd700; font-weight: bold;">${challenge.reward} ŸÜŸÇÿ∑ÿ©</span>
                  </div>
                  <p style="color: rgba(255,255,255,0.8); margin-bottom: 0.8rem; font-size: 0.9rem;">${challenge.desc}</p>
                  <button
                    style="background: ${btnColor}; color: ${btnTextColor}; font-weight: bold; padding: 0.6rem 1rem; border-radius: 0.6rem; border: none; cursor: ${btnDisabled ? 'not-allowed' : 'pointer'}; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: 0.3s; font-size: 0.9rem;"
                    ${btnDisabled ? 'disabled' : ''}
                    data-chain-id="${chainId}"
                    data-level="${level}"
                    data-challenge-name="${challenge.name}"
                    data-challenge-reward="${challenge.reward}"
                  >
                    ${btnText}
                  </button>
                </div>
                `;
            }
        }
        
        chainHtml += `
          </div>
        </div>
        `;
        
        chainsHtml += chainHtml;
        processedChains++;
    }
    
    // Add chains section to bonus challenge modal
    const bonusChallengeList = document.getElementById("bonusChallengeList");
    console.log('About to add chain section. processedChains:', processedChains);
    
    // Check for existing chain sections
    const existingChainSections = bonusChallengeList.querySelectorAll('[data-chain-section]');
    console.log('Existing chain sections found:', existingChainSections.length);
    
    if (processedChains > 0) {
        console.log('Adding chain section with HTML length:', chainsHtml.length);
        
        // Create the chain section element using createElement instead of innerHTML
        const chainSectionElement = document.createElement('div');
        chainSectionElement.setAttribute('data-chain-section', '');
        chainSectionElement.style.marginTop = '2rem';
        chainSectionElement.style.paddingTop = '2rem';
        chainSectionElement.style.borderTop = '2px solid rgba(204, 35, 102, 0.3)';
        
        chainSectionElement.innerHTML = `
          <h3 style="color: #667eea; text-align: center; margin-bottom: 1.5rem;">
            <i class="fas fa-link" style="margin-left: 0.5rem;"></i> ÿ≥ŸÑÿßÿ≥ŸÑ ÿßŸÑÿ™ÿ≠ÿØŸäÿßÿ™
          </h3>
          ${chainsHtml}
        `;
        
        // Append the element to the bonusChallengeList
        bonusChallengeList.appendChild(chainSectionElement);
        console.log('Chain section added successfully using appendChild');
    } else {
        console.log('No chains to process, skipping chain section addition');
    }
    
    // Add event listeners to chain challenge buttons
    console.log('Setting up event listeners for chain challenge buttons...');
    // Only look for chain buttons within the chain section, not the entire bonusChallengeList
    const chainSection = bonusChallengeList.querySelector('[data-chain-section]');
    if (chainSection) {
        const allChainButtons = chainSection.querySelectorAll('button[data-chain-id]');
        console.log('Total chain buttons with data-chain-id:', allChainButtons.length);
        const chainButtons = chainSection.querySelectorAll('button[data-chain-id]:not([disabled])');
        console.log('Found chain challenge buttons (not disabled):', chainButtons.length);
        
        // Debug: Log all chain buttons and their disabled state
        allChainButtons.forEach((btn, index) => {
            console.log(`Chain Button ${index}:`, btn.textContent.trim(), 'disabled:', btn.disabled, 'has disabled attr:', btn.hasAttribute('disabled'));
        });
        
        Array.from(chainButtons).forEach(btn => {
            console.log('Adding event listener to chain button:', btn.textContent.trim());
            btn.addEventListener('click', async function() {
                console.log('Chain challenge button clicked!');
                const chainId = btn.getAttribute('data-chain-id');
                const level = parseInt(btn.getAttribute('data-level'));
                const challengeName = btn.getAttribute('data-challenge-name');
                const challengeReward = btn.getAttribute('data-challenge-reward');
                const username = localStorage.getItem("username") || "";
                
                btn.disabled = true;
                btn.textContent = "‚è≥ ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ...";
                
                try {
                    // Register for the chain challenge
                    await setDoc(doc(collection(db, "chainRegistrations")), {
                        chainId,
                        level,
                        username,
                        challengeName,
                        challengeReward,
                        status: "pending",
                        timestamp: new Date()
                    });
                    
                    alert("ÿ™ŸÖ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿ®ŸÜÿ¨ÿßÿ≠! ÿ®ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑŸÖŸàÿßŸÅŸÇÿ©");
                    await loadBonusChallenges();
                } catch (e) {
                    alert("ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ");
                    console.error(e);
                    btn.disabled = false;
                    btn.textContent = 'ÿßŸÜÿ∂ŸÖ ŸÑŸÑÿ™ÿ≠ÿØŸä';
                }
            });
        });
    } else {
        console.log('No chain section found, skipping chain button event listeners');
    }
}

// Load chain challenges when bonus challenges are loaded
const originalLoadBonusChallenges = loadBonusChallenges;
loadBonusChallenges = async function() {
    console.log('=== loadBonusChallenges override called ===');
    await originalLoadBonusChallenges();
    console.log('Original loadBonusChallenges finished');
    // Clear any existing chain challenges before adding new ones
    const bonusChallengeList = document.getElementById("bonusChallengeList");
    const existingChainSection = bonusChallengeList.querySelector('[data-chain-section]');
    if (existingChainSection) {
        console.log('Found existing chain section, removing it');
        existingChainSection.remove();
    } else {
        console.log('No existing chain section found');
    }
    console.log('Calling loadChainChallenges...');
    await loadChainChallenges();
    console.log('loadChainChallenges finished');
};

// --- CHAIN CHALLENGES FEATURE END ---


        // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ

//         async function loadUsers() {
//     const tbody = document.querySelector("#usersTable tbody");
//     tbody.innerHTML = "";

//     try {
//         const usersRef = collection(db, "users");
//         const snapshot = await getDocs(usersRef);
    
//         // Convert snapshot to array and sort by 'lkogy' in descending order
//         const users = snapshot.docs
//             .map(doc => doc.data())  
//             .sort((a, b) => (b.lkogy || 0) - (a.lkogy || 0)) 
//             .slice(0, 5); 

//         // Ensure table headers exist
//         const thead = document.querySelector("#usersTable thead");
//         if (!thead.innerHTML.trim()) {
//             thead.innerHTML = `
//                 <tr>
//                     <th>Rank</th>
//                     <th>Name</th>
//                     <th>Lkogy</th>
//                 </tr>
//             `;
//         }

//         // Append the top 5 users to the table with correct alignment
//         users.forEach((user, index) => {
//             const row = document.createElement("tr");
//             row.setAttribute("data-gender", user.gender);
//             row.setAttribute("data-stage", user.stage);
//             row.innerHTML = `
//                 <td style="font-weight: 900;">#${index + 1}</td>  <!-- Rank Number -->
//                 <td>${user.name}</td>
//                 <td>${user.lkogy || 0}</td>
//             `;
//             tbody.appendChild(row);
//         });

//     } catch (error) {
//         console.error("ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ:", error);
//         showAlert("ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ", "error");
//     }
// }


        // loadState();
        // setInterval(resetDailyActivities, 60000);
        window.addEventListener("load", loadUsers);
        // Override existing function with vibration support
    window.addPoints = function(activityId) {
        try {
            const activity = state.activities.find(a => a.id === activityId);
            if (activity && canUseActivity(activity)) {
                if (navigator.vibrate) navigator.vibrate(100); // Vibration
                playSoundEffect();

                state.points += activity.points;
                updateFirestoreValueByAuth(localStorage.getItem("username"), localStorage.getItem("password"), "lkogy", state.points);
                activity.lastUsed = new Date().getTime();
                if (activity.displayName !== undefined) {
                    var acDisplayName = activity.displayName;
                }
                state.history.unshift({
                    id: Date.now(),
                    activityName: acDisplayName || activity.name,
                    points: activity.points,
                    timestamp: new Date().toLocaleString('ar-EG'),
                    type: 'earn'
                });
                updateFirestoreValueByAuth2(localStorage.getItem("username"), localStorage.getItem("password"), activity.name, activity.lastUsed);
                saveState();
                updateUI();
                showToast(`ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ${activity.points} ŸÜŸÇÿ∑ÿ© ÿ®ŸÜÿ¨ÿßÿ≠`);
                loadUsers();
            } else {
                if (navigator.vibrate) navigator.vibrate([50, 50, 50]); // Error vibration
                showToast('ŸÑŸÇÿØ ŸÇŸÖÿ™ ÿ®Ÿáÿ∞ÿß ÿßŸÑŸÜÿ¥ÿßÿ∑ ÿßŸÑŸäŸàŸÖ ÿ®ÿßŸÑŸÅÿπŸÑ', 'error');
            }
        } catch (error) {
            console.error('Error adding points:', error);
            showToast('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÜŸÇÿßÿ∑', 'error');
        }
    };


    window.addEventListener("load", async () => {
        // Show loading screen
        // document.getElementById("loading-screen").style.display = "flex";
        
        try {
            // Load all data before hiding loading screen
            await Promise.all([
                loadState(),
                loadUsers(),
                fetchProducts() // If needed for exchange modal
            ]);
            
            // Initialize UI
            updateUI();
            
            // Check for daily reset
            resetDailyActivities();
            
        } catch (error) {
            console.error("Initial load error:", error);
        } // finally {
        //     // Hide loading screen after everything is loaded
        //     setTimeout(() => {
        //         document.getElementById("loading-screen").classList.add("hide");
        //         setTimeout(() => {
        //             document.getElementById("loading-screen").style.display = "none";
        //         }, 1000);
        //     }, 1000); // Minimum 1 second loading time
        // }
    });

    // Mr.Marc Akram - Front-end developer Left his mark here

    // show Date
    const DateEle = document.getElementById("Date");

    DateEle.innerHTML =`<span> ${new Date().toLocaleDateString('ar-EG', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        weekday: 'long'
    })} </span>`

    DateEle.style.display = "flex";
    DateEle.style.flexDirection = "column";


    console.warn("DO NOT PASTE ANY CODE HERE - HACKERS MAY STEAL YOUR INFO");
    console.warn("It seems that you know how to open console - if you have experience contact us we might find an appropriate job for you.")

    // After activities are loaded and updateUI is called, render the quest buttons
    function renderQuestButtons() {
      const container = document.getElementById('questsActionButtons');
      if (!container) return;
      // Only show today's visible quests
      const todayQuests = state.activities.filter(a => a.isActiveToday && a.status === 'visible');
      if (todayQuests.length === 0) {
        container.innerHTML = '';
        return;
      }
      container.innerHTML = todayQuests.map(activity => `
        <button class="quest-action-btn" onclick="addPoints('${activity.id}')">
          <span class="activity-icon">${activity.icon}</span> ${activity.displayName || activity.name}
        </button>
      `).join('');
    }

    function shouldShowTaskForUser(task, user) {
      // Gender check
      if (task.gender && task.gender !== 'all' && task.gender !== user.gender) {
        return false;
      }
      // Stage check
      if (task.stage && task.stage !== 'all' && task.stage !== user.stage) {
        return false;
      }
      // Day check
      const today = new Date().getDay(); // 0 = Sunday, 1 = Monday, ...
      if (Array.isArray(task.activeDays) && !task.activeDays.includes(today)) {
        return false;
      }
      return true;
    }

    // Add this function to handle editing a task
    window.editTask = function(taskId) {
      const task = state.activities.find(a => a.id === taskId);
      if (!task) return;

      // Set form fields to current values
      document.getElementById('newTaskName').value = task.name || '';
      document.getElementById('newTaskPoints').value = task.points || 1;
      document.getElementById('newTaskIcon').value = task.icon || '';
      document.getElementById('newTaskStage').value = task.stage || 'all';
      document.getElementById('newTaskGender').value = task.gender || 'all';
      document.getElementById('newTaskStatus').value = task.status || 'visible';

      // Set days checkboxes
      document.querySelectorAll('input[name="newTaskDays"]').forEach(cb => {
        cb.checked = Array.isArray(task.activeDays) && task.activeDays.includes(Number(cb.value));
      });

      // Set refresh cycle
      document.getElementById('newTaskRefreshCycle').value = task.refreshCycle || 'daily';

      // Set a flag to indicate editing
      window.currentlyEditingTaskId = taskId;
    };

    // Patch addNewTask to handle editing
    const originalAddNewTask = window.addNewTask;
    window.addNewTask = function() {
      const name = document.getElementById('newTaskName').value.trim();
      const points = parseInt(document.getElementById('newTaskPoints').value);
      const icon = document.getElementById('newTaskIcon').value.trim();
      const stage = document.getElementById('newTaskStage').value;
      const gender = document.getElementById('newTaskGender').value;
      const status = document.getElementById('newTaskStatus').value;
      const refreshCycle = document.getElementById('newTaskRefreshCycle').value;
      const activeDays = Array.from(document.querySelectorAll('input[name="newTaskDays"]:checked')).map(cb => Number(cb.value));

      if (!name || !points || !icon) {
        showToast('ÿ®ÿ±ÿ¨ÿßÿ° ŸÖŸÑÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™', 'error');
        return;
      }
      if (points < 1) {
        showToast('ÿπÿØÿØ ÿßŸÑŸÜŸÇÿßÿ∑ Ÿäÿ¨ÿ® ÿ£ŸÜ ŸäŸÉŸàŸÜ ÿ£ŸÉÿ®ÿ± ŸÖŸÜ ÿµŸÅÿ±', 'error');
        return;
      }

      if (window.currentlyEditingTaskId) {
        // Update existing task
        const task = state.activities.find(a => a.id === window.currentlyEditingTaskId);
        if (task) {
          task.name = name;
          task.points = points;
          task.icon = icon;
          task.stage = stage;
          task.gender = gender;
          task.status = status;
          task.activeDays = activeDays;
          task.refreshCycle = refreshCycle;
        }
        window.currentlyEditingTaskId = null;
        showToast('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖŸáŸÖÿ© ÿ®ŸÜÿ¨ÿßÿ≠');
      } else {
        // Add new task as before
        originalAddNewTask();
        return;
      }
      saveState();
      updateTasksList();
      updateUI();
      // Clear form
      document.getElementById('newTaskName').value = '';
      document.getElementById('newTaskPoints').value = '';
      document.getElementById('newTaskIcon').value = '';
      document.getElementById('newTaskStage').value = 'all';
      document.getElementById('newTaskGender').value = 'all';
      document.getElementById('newTaskStatus').value = 'visible';
      document.getElementById('newTaskRefreshCycle').value = 'daily';
      document.querySelectorAll('input[name="newTaskDays"]').forEach(cb => cb.checked = true);
    };
</script>
<script>
    // ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÅŸàÿ™ÿ± ÿßŸÑŸÖŸÖŸäÿ≤ ÿ®ÿ≤ŸàÿßŸäÿß ŸÖŸÜÿ≠ŸÜŸäÿ©
    if (window.localStorage.getItem("login") == "true") {
        document.addEventListener('DOMContentLoaded', function() {
      // ÿ•ŸÜÿ¥ÿßÿ° ÿπŸÜÿµÿ± ÿßŸÑŸÅŸàÿ™ÿ±
      const footer = document.createElement('footer');
      footer.className = 'premium-footer';
      footer.dir = 'rtl';
      footer.lang = 'ar';
      
      // ŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑŸÅŸàÿ™ÿ± ÿßŸÑŸÖÿ™ŸÖŸäÿ≤
      footer.innerHTML = `
        <div class="footer-container">
          <div class="copyright-section">
            <span class="copyright-text">ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÇ ŸÖÿ≠ŸÅŸàÿ∏ÿ©</span>
            <span class="separator">-</span>
            <span class="brand-name">ÿßŸÜÿ≥ÿ™ÿß ŸÑŸÉŸàÿ¨Ÿä</span>
            <span class="current-year">2025</span>
            <span class="copyright-symbol">¬©</span>
          </div>
          <div class="links-section">
            <a href="https://insta-lkogy-privacy.netlify.app" class="footer-link">
              <i class="fas fa-lock icon"></i> ÿ≥Ÿäÿßÿ≥ÿ© ÿßŸÑÿÆÿµŸàÿµŸäÿ©
            </a>
            <a href="https://insta-lkogy-terms.netlify.app"class="footer-link">
              <i class="fas fa-file-alt icon"></i> ÿ¥ÿ±Ÿàÿ∑ ÿßŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ
            </a>
          </div>
        </div>
      `;
      
      // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÅŸàÿ™ÿ± ÿ•ŸÑŸâ ŸÜŸáÿßŸäÿ© ÿßŸÑÿµŸÅÿ≠ÿ©
      document.querySelector(".container").appendChild(footer);
      
      // ÿ•ŸÜÿ¥ÿßÿ° Ÿàÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ™ŸÜÿ≥ŸäŸÇÿßÿ™ ÿßŸÑŸÖÿ™ŸÖŸäÿ≤ÿ©
      const style = document.createElement('style');
      style.textContent = `
        /* ÿ™ŸÜÿ≥ŸäŸÇÿßÿ™ ÿßŸÑŸÅŸàÿ™ÿ± ÿßŸÑŸÖÿ™ŸÖŸäÿ≤ */
        .premium-footer {
          padding: 25px 20px;
          background: linear-gradient(135deg, rgba(30, 30, 30, 0.95), rgba(20, 20, 20, 0.95));
          border-top-left-radius: 25px;
          border-top-right-radius: 25px;
          font-family: 'Cairo', sans-serif;
          margin-top: 50px;
          text-align: center;
          line-height: 1.6;
          font-size: 15px;
          color: #ffffff;
          backdrop-filter: blur(10px);
          box-shadow: 0 -4px 25px rgba(0, 0, 0, 0.4);
          border-top: 2px solid rgba(255, 107, 53, 0.5);
          position: relative;
          z-index: 100;
        }
        
        .premium-footer .footer-container {
          max-width: 1200px;
          margin: 0 auto;
          display: flex;
          flex-direction: column;
          gap: 15px;
        }
        
        .premium-footer .brand-name {
          font-weight: bold;
          color: #FF914D; /* ÿ®ÿ±ÿ™ŸÇÿßŸÑŸä ÿ£ŸÉÿ´ÿ± ÿØŸÅÿ¶ÿßŸã */
          margin: 0 3px;
          font-size: 1.1em;
          text-shadow: 0 0 8px rgba(255, 145, 77, 0.3);
          transition: all 0.3s ease;
        }
        
        .premium-footer .brand-name:hover {
          color: #FF6B35;
          text-shadow: 0 0 12px rgba(255, 107, 53, 0.5);
        }
        
        .premium-footer .copyright-text {
          color: #e0e0e0;
        }
        
        .premium-footer .current-year {
          color: #f0f0f0;
          margin: 0 3px;
          font-weight: 500;
        }
        
        .premium-footer .copyright-symbol {
          margin-right: 3px;
          color: #FF6B35;
        }
        
        .premium-footer .footer-link {
          color: #FF914D;
          text-decoration: none;
          margin: 0 15px;
          transition: all 0.3s ease;
          padding: 8px 18px;
          border-radius: 20px;
          background: linear-gradient(135deg, rgba(255, 107, 53, 0.15), rgba(255, 145, 77, 0.1));
          border: 1px solid rgba(255, 107, 53, 0.3);
          font-weight: 600;
          position: relative;
          overflow: hidden;
        }
        
        .premium-footer .footer-link:hover {
          color: #ffffff;
          background: linear-gradient(135deg, rgba(255, 107, 53, 0.25), rgba(255, 145, 77, 0.2));
          transform: translateY(-3px);
          box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
        }
        
        .premium-footer .footer-link::before {
          content: '';
          position: absolute;
          top: 0;
          left: -100%;
          width: 100%;
          height: 100%;
          background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
          transition: 0.5s;
        }
        
        .premium-footer .footer-link:hover::before {
          left: 100%;
        }
        
        .premium-footer .separator {
          color: rgba(255, 107, 53, 0.7);
          margin: 0 5px;
          font-weight: bold;
        }
        
        .premium-footer .icon {
          margin-left: 6px;
          color: #FF6B35;
          transition: all 0.3s ease;
        }
        
        .premium-footer .footer-link:hover .icon {
          color: #ffffff;
          transform: scale(1.1);
        }
        
        .premium-footer .links-section {
          display: flex;
          justify-content: center;
          flex-wrap: wrap;
          gap: 15px;
          margin-top: 15px;
        }
        
        /* ÿßŸÑÿ™ŸÉŸäŸÅ ŸÖÿπ ÿßŸÑÿ¥ÿßÿ¥ÿßÿ™ ÿßŸÑÿµÿ∫Ÿäÿ±ÿ© */
        @media (max-width: 768px) {
          .premium-footer {
            padding: 20px 15px;
            border-radius: 20px 20px 0 0;
            font-size: 14px;
            backdrop-filter: blur(8px);
          }
          
          .premium-footer .footer-container {
            gap: 12px;
          }
          
          .premium-footer .footer-link {
            margin: 0;
            padding: 8px 15px;
            font-size: 0.9em;
            text-align: center;
          }
          
          .premium-footer .separator {
            margin: 0 3px;
          }
          
          .premium-footer .links-section {
            flex-direction: column;
            gap: 10px;
          }
        }
      `;
      
      // ÿ•ÿ∂ÿßŸÅÿ© ÿ£ŸäŸÇŸàŸÜÿßÿ™ Font Awesome ÿ•ÿ∞ÿß ŸÑŸÖ ÿ™ŸÉŸÜ ŸÖŸàÿ¨ŸàÿØÿ©
      if (!document.querySelector('link[href*="font-awesome"]')) {
        const faLink = document.createElement('link');
        faLink.rel = 'stylesheet';
        faLink.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css';
        document.head.appendChild(faLink);
      }
      
      // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ™ŸÜÿ≥ŸäŸÇÿßÿ™ ÿ•ŸÑŸâ ÿßŸÑÿµŸÅÿ≠ÿ©
      document.head.appendChild(style);
      
      // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ≥ŸÜÿ© ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã
      const yearElement = footer.querySelector('.current-year');
      yearElement.textContent = new Date().getFullYear();
    });
    }
</script>

</body>
</html> 
